@{
    ViewData["Title"] = "Files";
}

<!-- Toast Container -->
<div class="fm-toast-container" id="toastContainer"></div>

<!-- Drop Overlay -->
<div class="fm-drop-overlay" id="dropOverlay">
    <div class="fm-drop-content">
        <div class="fm-drop-icon">üìÅ</div>
        <div class="fm-drop-text">Drop files or folders here</div>
        <div class="fm-drop-hint">Release to upload your files and folders with structure preserved</div>
    </div>
</div>

<div class="file-manager-container">
    <!-- Header -->
    <div class="fm-header">
        <a href="~/Home/index" class="logo-text-a">
            <h1 class="fm-title">
                <div class="fm-title-icon">‚òÅÔ∏è</div>
                SpaceHSG
            </h1>
        </a>
        <div class="fm-toolbar">
            <button id="uploadBtn" class="fm-btn fm-btn-primary" onclick="document.getElementById('fileInput').click()">
                <span class="fm-btn-icon">‚¨ÜÔ∏è</span>
                Upload
            </button>
            <button id="newFolderBtn" class="fm-btn" onclick="showCreateFolderModal()">
                <span class="fm-btn-icon">‚ûï</span>
                New Folder
            </button>
            <button class="fm-btn" onclick="refreshFileListWithoutReload()" title="Refresh without reloading page">
                <span class="fm-btn-icon">üîÑ</span>
                Refresh
            </button>
            <button class="fm-theme-toggle" id="themeToggle" onclick="toggleThemeNow()">
                <span id="themeIcon">üåô</span>
            </button>
            <div class="fm-view-toggle">
                <button class="fm-view-btn active" id="viewGrid" onclick="switchView('grid')">
                    <span>‚äû</span>
                </button>
                <button class="fm-view-btn" id="viewList" onclick="switchView('list')">
                    <span>‚ò∞</span>
                </button>
            </div>

            <button id="logoutBtn" class="fm-btn fm-btn-logout">
                Logout ‚èª
            </button>
        </div>
    </div>

    <!-- Breadcrumb Navigation -->
    @if (ViewBag.Breadcrumbs != null)
    {
        <div class="fm-breadcrumb">
            @foreach (var crumb in ViewBag.Breadcrumbs)
            {
                if (crumb.IsActive)
                {
                    <div class="fm-breadcrumb-item">
                        <span class="fm-breadcrumb-current">@crumb.Name</span>
                    </div>
                }
                else
                {
                    <div class="fm-breadcrumb-item">
                        <a href="@Url.Action("Index", new { path = crumb.Path })" class="fm-breadcrumb-link">
                            @crumb.Name
                        </a>
                        <span class="fm-breadcrumb-separator">‚Ä∫</span>
                    </div>
                }
            }
        </div>
    }

    <!-- Hidden File Input (supports both files and folders) -->
    <input type="file" id="fileInput" multiple style="display: none;" />

    <!-- Hidden Progress -->
    <div class="fm-progress" id="uploadProgress" style="position: fixed; top: 0; left: 0; right: 0; z-index: 9998;">
        <div class="fm-progress-bar" id="uploadProgressBar"></div>
    </div>

    <!-- Create Folder Modal -->
    <div class="fm-modal-overlay" id="createFolderModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Create New Folder</h3>
                <button class="fm-modal-close" onclick="hideCreateFolderModal()">√ó</button>
            </div>
            <div class="fm-modal-body">
                <div class="fm-form-group">
                    <label class="fm-form-label" for="folderNameInput">Folder Name</label>
                    <input type="text" class="fm-form-input" id="folderNameInput" placeholder="Enter folder name" />
                </div>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideCreateFolderModal()">Cancel</button>
                <button class="fm-btn fm-btn-primary" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="fm-modal-overlay" id="deleteModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Confirm Delete</h3>
                <button class="fm-modal-close" onclick="hideDeleteModal()">√ó</button>
            </div>
            <div class="fm-modal-body">
                <p>Are you sure you want to delete "<strong id="deleteItemName"></strong>"?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">This action cannot be undone.</p>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button class="fm-btn fm-btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @ViewBag.Error
        </div>
    }

    <!-- Files Container -->
    <div class="fm-files-container">
        <div class="fm-files-header">
            <!-- Â∑¶‰æßÔºöÂÖ®ÈÄâÊåâÈíÆ + Êñá‰ª∂ÁªüËÆ° -->
            <div class="fm-header-left">
                <div class="fm-select-all-container">
                    <button class="fm-select-all-btn" id="selectAllHeader" title="Select all items">
                        <span class="fm-select-all-icon"></span>
                        All
                    </button>
                </div>
                <div class="fm-files-count">
                    @{
                        var itemsList = ViewBag.Items as IEnumerable<dynamic>;
                        var folderCount = 0;
                        var fileCount = 0;

                        if (itemsList != null)
                        {
                            folderCount = itemsList.Count(x => x.Type == "Folder");
                            fileCount = itemsList.Count(x => x.Type == "File");
                        }
                    }
                    @folderCount folders, @fileCount files
                </div>
            </div>

            <!-- Âè≥‰æßÔºöÊâπÈáèÊìç‰ΩúÊåâÈíÆ (ÈªòËÆ§ÈöêËóè) -->
            <div class="fm-batch-actions" id="batchActions" style="display: none;">
                <div class="fm-selected-count" id="selectedCount">
                    <span id="selectedNumber">0</span> selected
                </div>
                <button class="fm-btn fm-btn-danger" id="batchDeleteBtn" title="Delete selected items">
                    <span class="fm-btn-icon">üóëÔ∏è</span>
                    Delete Selected
                </button>
            </div>
        </div>

        @if (ViewBag.Items != null && ViewBag.Items.Count > 0)
        {
            <!-- Grid View (Default) -->
            <div class="fm-grid-view" id="gridView">
                @foreach (var item in ViewBag.Items)
                {
                    <div class="fm-grid-item" data-path="@item.Path" onclick="navigateToItem('@(item.Type == "Folder" ?
                                                                                                                                                                                                                                                                                                                                                                                                                                                        Url.Action("Index", new { path = item.Path }) :
                                                                                                                                                                                                                                                                                                                                                                                                                                                        Url.Action("Download", new { path = item.Path }))')">
                        <button class="fm-delete-btn" onclick="event.stopPropagation(); showDeleteModal('@item.Name', '@item.Path')" title="Delete">üóëÔ∏è</button>
                        <div class="fm-grid-item-icon fm-icon-@(item.Type == "Folder" ? "folder" : item.Extension.TrimStart('.'))">
                            @if (item.Type == "Folder")
                            {
                                <text>üìÅ</text>
                            }
                            else
                            {
                                @GetFileIcon(item.Extension)
                            }
                        </div>
                        <div class="fm-grid-item-name" title="@item.Name">@item.Name</div>
                        @if (item.Type == "File")
                        {
                            <div class="fm-grid-item-info">@FormatFileSize(item.Size)</div>
                        }
                        else
                        {
                            <div class="fm-grid-item-info">Folder</div>
                        }
                    </div>
                }
            </div>

            <!-- List View (Hidden by default) -->
            <div class="fm-list-view" id="listView" style="display: none;">
                <div class="fm-list-header">
                    <!-- ÂÖ®ÈÄâÂ§çÈÄâÊ°Ü -->
                    <div class="fm-list-checkbox-container fm-write-permission-only" onclick="toggleSelectAll()">
                        <div class="fm-list-checkbox" id="selectAllCheckbox"></div>
                    </div>
                    <div></div>
                    <div>Name</div>
                    <div>Type</div>
                    <div>Size</div>
                    <div>Modified</div>
                    <div>Actions</div>
                </div>
                @foreach (var item in ViewBag.Items)
                {
                    <div class="fm-list-item" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type">
                        <div class="fm-list-checkbox-container fm-write-permission-only" onclick="event.stopPropagation();">
                            <div class="fm-list-checkbox"></div>
                        </div>
                        <div class="fm-list-icon fm-icon-@(item.Type == "Folder" ? "folder" : item.Extension.TrimStart('.'))"
                             onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <text>üìÅ</text>
                            }
                            else
                            {
                                @GetFileIcon(item.Extension)
                            }
                        </div>
                        <div class="fm-list-name" title="@item.Name" onclick="navigateToItemByElement(this)">@item.Name</div>
                        <div class="fm-list-type" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <span class="fm-badge fm-badge-folder">Folder</span>
                            }
                            else
                            {
                                <span class="fm-badge fm-badge-file">@item.Extension</span>
                            }
                        </div>
                        <div class="fm-list-size" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "File")
                            {
                                @FormatFileSize(item.Size)
                            }
                            else
                            {
                                <text>‚Äî</text>
                            }
                        </div>
                        <div class="fm-list-date" onclick="navigateToItemByElement(this)">@item.Modified.ToString("MMM dd, yyyy")</div>
                        <div class="fm-list-actions" onclick="event.stopPropagation()">
                            @if (item.Type == "File")
                            {
                                <button class="fm-action-btn download-icon-btn" title="Download">
                                    <span class="fm-action-icon">üì•</span>
                                </button>
                            }
                            else
                            {
                                <button class="fm-action-btn open-icon-btn" title="Open">
                                    <span class="fm-action-icon">üìÇ</span>
                                </button>
                            }
                            @* <button class="fm-action-btn delete-icon-btn" title="Delete">
                                <span class="fm-action-icon" style="color: #e81123;">üóëÔ∏è</span>
                            </button> *@
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="fm-empty">
                <div class="fm-empty-icon">üìÇ</div>
                <div class="fm-empty-text">This folder is empty</div>
                <div class="fm-empty-hint">Drag files here or click Upload to add files</div>
            </div>
        }
    </div>
</div>

@functions {
    string GetFileIcon(string extension)
    {
        return extension?.ToLower() switch
        {
            ".doc" or ".docx" => "üìÑ",
            ".xls" or ".xlsx" => "üìä",
            ".ppt" or ".pptx" => "üìΩÔ∏è",
            ".pdf" => "üìï",
            ".txt" => "üìù",
            ".zip" or ".rar" or ".7z" => "üì¶",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" => "üñºÔ∏è",
            ".mp4" or ".avi" or ".mov" or ".wmv" => "üé¨",
            ".mp3" or ".wav" or ".flac" => "üéµ",
            ".exe" => "‚öôÔ∏è",
            ".html" or ".htm" => "üåê",
            ".css" => "üé®",
            ".js" => "üìú",
            ".json" => "üìã",
            ".xml" => "üìã",
            ".cs" => "üíª",
            ".py" => "üêç",
            ".java" => "‚òï",
            _ => "üìÑ"
        };
    }

    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

<!-- ÂàùÂßãÂåñËÑöÊú¨ -->
<script>
    // È°µÈù¢Âä†ËΩΩÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        @* console.log('===========================================');
        console.log('PAGE LOAD - Index.cshtml');
        console.log('ViewBag.RelativePath:', '@ViewBag.RelativePath');
        console.log('ViewBag.UserDepartment:', '@ViewBag.UserDepartment');
        console.log('==========================================='); *@

        // ========== ËÆæÁΩÆÂÖ®Â±ÄÁî®Êà∑‰ø°ÊÅØ ==========
        window.userDepartment = '@(ViewBag.UserDepartment ?? "Unknown")';
        window.userDisplayName = '@(ViewBag.UserDisplayName ?? "")';
        window.userRole = '@(ViewBag.UserRole ?? "User")';
        
        @* console.log('User Department:', window.userDepartment);
        console.log('User Display Name:', window.userDisplayName);
        console.log('User Role:', window.userRole); *@

        // ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáè
        const relativePath = '@(ViewBag.RelativePath ?? "")';
        @* console.log('Calling initializeFileManager with path:', relativePath); *@
        
        if (typeof initializeFileManager === 'function') {
            initializeFileManager(relativePath, '@Url.Action("Upload", "Home")');
        } else {
            showToast('Error', 'InitializeFileManager function not found!', 'error');
        }

        // ========== Ê†πÊçÆÊùÉÈôêÊòæÁ§∫/ÈöêËóèÊåâÈíÆ ==========
        checkAndUpdateButtonsVisibility();

        // ËÆæÁΩÆÁôªÂá∫ÊåâÈíÆ‰∫ã‰ª∂ - Ê∏ÖÈô§localStorage
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if (confirm("Are you sure you want to logout?")) {
                    // Clear localStorage
                    localStorage.removeItem('spaceHSG_user');
                    @* console.log('localStorage cleared on logout'); *@
                    window.location.href = '@Url.Action("Logout", "Account")';
                }
            });
        }

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ
        @if (ViewBag.Error != null)
        {
                    <text>
                        setTimeout(() => {
                            showToast('Error', '@Html.Raw(ViewBag.Error)', 'error');
                        }, 1000);
                    </text>
        }

        @* console.log('File Manager initialized successfully'); *@
    });

    // ÂÖ®Â±ÄËæÖÂä©ÂáΩÊï∞
    function showToast(title, message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;

        const toast = document.createElement('div');
        toast.className = `fm-toast fm-toast-${type}`;

        const icons = {
            'success': '‚úÖ',
            'error': '‚ùå',
            'warning': '‚ö†Ô∏è',
            'info': '‚ÑπÔ∏è'
        };

        toast.innerHTML = `
            <div class="fm-toast-icon">${icons[type] || icons.info}</div>
            <div class="fm-toast-content">
                <div class="fm-toast-title">${title}</div>
                <div class="fm-toast-message">${message}</div>
            </div>
            <button class="fm-toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;

        toastContainer.appendChild(toast);

        // Ëá™Âä®ÁßªÈô§
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    // Êö¥Èú≤ÁªôÂÖ®Â±Ä‰ΩúÁî®Âüü
    window.showToast = showToast;

    // Ë¶ÜÁõñÂéüÊù•ÁöÑ showCreateFolderModal ÂáΩÊï∞
    window.showCreateFolderModal = function() {
        const modal = document.getElementById('createFolderModal');
        const input = document.getElementById('folderNameInput');

        if (modal) modal.classList.add('active');
        if (input) {
            input.value = '';
            input.focus();
        }

        @* console.log('Creating folder in path:', currentPath || 'root'); *@
    };
</script>