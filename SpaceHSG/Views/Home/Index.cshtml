@{
    ViewData["Title"] = "Files";
}

<!-- Toast Container -->
<div class="fm-toast-container" id="toastContainer"></div>

<!-- Drop Overlay -->
<div class="fm-drop-overlay" id="dropOverlay">
    <div class="fm-drop-content">
        @* <div class="fm-drop-icon">ğŸ“</div> *@
        <div class="fm-drop-icon"><i class="fas fa-folder-open"></i></div>
        <div class="fm-drop-text">Drop files or folders here</div>
        <div class="fm-drop-hint">Release to upload your files and folders with structure preserved</div>
    </div>
</div>

<div class="file-manager-container">
    <!-- Header -->
    <div class="fm-header">
        <a href="@Url.Content("~/Home/index")" class="logo-text-a">
            <h1 class="fm-title">
                <img src="@Url.Content("~/Logo/logo.png")" alt="Logo" class="fm-title-icon"
                     style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px;" />SpaceHSG
            </h1>
        </a>
        <div class="fm-toolbar">
            <div class="fm-toolbar-left">
                <!-- æ¡Œé¢ç«¯æœç´¢æ  - åªåœ¨éæ ¹ç›®å½•æ˜¾ç¤º -->
                @if (ViewBag.RelativePath != null && !string.IsNullOrEmpty(ViewBag.RelativePath))
                {
                    <div class="fm-toolbar-search desktop-only">
                        <div class="fm-search-container">
                            <i class="fas fa-search fm-search-icon"></i>
                            <input type="text"
                                   class="fm-search-input"
                                   id="searchInput"
                                   placeholder="Search files and folders..."
                                   onkeyup="handleSearch(event)">
                            <button class="fm-search-clear" id="searchClear" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                }

                <button id="uploadBtn" class="fm-btn fm-btn-primary" onclick="document.getElementById('fileInput').click()">
                    <span class="fm-btn-icon"><i class="fas fa-upload"></i></span>
                    Upload
                </button>
                <button id="newFolderBtn" class="fm-btn" onclick="showCreateFolderModal()">
                    <span class="fm-btn-icon"><i class="fas fa-folder-plus"></i></span>
                    New Folder
                </button>
                <button class="fm-btn" onclick="refreshFileListWithoutReload()" title="Refresh without reloading page">
                    <span class="fm-btn-icon"><i class="fas fa-rotate-right"></i></span>
                    Refresh
                </button>
                <button class="fm-theme-toggle" id="themeToggle" onclick="toggleThemeNow()">
                    <span id="themeIcon"><i class="fas fa-moon"></i></span>
                </button>
            </div>
            <div class="fm-view-toggle">
                <button class="fm-view-btn active" id="viewGrid" onclick="switchView('grid')">
                    <span><i class="fas fa-th-large"></i></span>
                </button>
                <button class="fm-view-btn" id="viewList" onclick="switchView('list')">
                    <span><i class="fas fa-list"></i></span>
                </button>
            </div>

            <div class="fm-toolbar-right-logout">
                <button id="logoutBtn" class="fm-btn fm-btn-logout">
                    Logout<i class="fas fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯æœç´¢æ  - åªåœ¨éæ ¹ç›®å½•æ˜¾ç¤º -->
    @if (ViewBag.RelativePath != null && !string.IsNullOrEmpty(ViewBag.RelativePath))
    {
        <div class="fm-toolbar-search mobile-only">
            <div class="fm-search-container">
                <i class="fas fa-search fm-search-icon"></i>
                <input type="text"
                       class="fm-search-input"
                       id="mobileSearchInput"
                       placeholder="Search files and folders..."
                       onkeyup="handleMobileSearch(event)">
                <button class="fm-search-clear" id="mobileSearchClear" onclick="clearMobileSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    }

    <!-- Breadcrumb Navigation -->
    @if (ViewBag.Breadcrumbs != null)
    {
        <div class="fm-breadcrumb">
            @foreach (var crumb in ViewBag.Breadcrumbs)
            {
                if (crumb.IsActive)
                {
                    <div class="fm-breadcrumb-item">
                        <span class="fm-breadcrumb-current">@crumb.Name</span>
                    </div>
                }
                else
                {
                    <div class="fm-breadcrumb-item">
                        <a href="@Url.Action("Index", new { path = crumb.Path })" class="fm-breadcrumb-link">
                            @crumb.Name
                        </a>
                        <span class="fm-breadcrumb-separator">â€º</span>
                    </div>
                }
            }
        </div>
    }

    <!-- Hidden File Input (supports both files and folders) -->
    <input type="file" id="fileInput" multiple style="display: none;" />

    <!-- Hidden Progress -->
    <div class="fm-progress" id="uploadProgress" style="position: fixed; top: 0; left: 0; right: 0; z-index: 9998;">
        <div class="fm-progress-bar" id="uploadProgressBar"></div>
    </div>

    <!-- Create Folder Modal -->
    <div class="fm-modal-overlay" id="createFolderModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Create New Folder</h3>
                <button class="fm-modal-close" onclick="hideCreateFolderModal()">Ã—</button>
            </div>
            <div class="fm-modal-body">
                <div class="fm-form-group">
                    <label class="fm-form-label" for="folderNameInput">Folder Name</label>
                    <input type="text" class="fm-form-input" id="folderNameInput" placeholder="Enter folder name" />
                </div>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideCreateFolderModal()">Cancel</button>
                <button class="fm-btn fm-btn-primary" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="fm-modal-overlay" id="batchDeleteModal" style="display: none;">
        <div class="fm-modal-box">
            <div class="fm-modal-icon-header danger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </div>
            <div class="fm-modal-content">
                <h3>Delete Selected Items</h3>
                <p>Are you sure you want to delete <strong id="batchDeleteCount">0</strong> selected item(s)?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">This action cannot be undone.</p>
            </div>
            <div class="fm-modal-actions">
                <button class="fm-btn-text" onclick="hideBatchDeleteModal()">Cancel</button>
                <button class="fm-btn-danger" onclick="confirmBatchDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <!-- <div class="fm-modal-overlay" id="deleteModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Confirm Delete</h3>
                <button class="fm-modal-close" onclick="hideDeleteModal()">Ã—</button>
            </div>
            <div class="fm-modal-body">
                <p>Are you sure you want to delete "<strong id="deleteItemName"></strong>"?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">This action cannot be undone.</p>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button class="fm-btn fm-btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div> -->
    <!-- Error Message -->
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @ViewBag.Error
        </div>
    }

    <!-- Files Container -->
    <div class="fm-files-container">
        <div class="fm-files-header">
            <!-- å·¦ä¾§ï¼šå…¨é€‰æŒ‰é’® + æ–‡ä»¶ç»Ÿè®¡ -->
            <div class="fm-header-left">
                <div class="fm-select-all-container fm-write-permission-only">
                    <button class="fm-select-all-btn" id="selectAllHeader" title="Select all items">
                        <span class="fm-select-all-icon"></span>
                        All
                    </button>
                </div>
                <div class="fm-files-count">
                    @{
                        // ä¿®å¤ï¼šå®‰å…¨å¤„ç†ViewBag.Itemsçš„ç±»å‹è½¬æ¢
                        var itemsList = ViewBag.Items as System.Collections.IEnumerable;
                        var folderCount = 0;
                        var fileCount = 0;

                        if (itemsList != null)
                        {
                            // ä½¿ç”¨åŠ¨æ€ç±»å‹è®¿é—®æˆ–å®‰å…¨çš„è½¬æ¢æ–¹å¼
                            foreach (dynamic item in itemsList)
                            {
                                if (item.Type == "Folder")
                                    folderCount++;
                                else
                                    fileCount++;
                            }
                        }
                    }
                    @folderCount folders, @fileCount files
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ‰¹é‡æ“ä½œæŒ‰é’® (é»˜è®¤éšè—) -->
            <div class="fm-batch-actions fm-write-permission-only" id="batchActions" style="display: none;">
                <div class="fm-selected-count" id="selectedCount">
                    <span id="selectedNumber">0</span> selected
                </div>
                <button class="fm-btn fm-btn-danger" id="batchDeleteBtn" title="Delete selected items">
                    @*<span class="fm-btn-icon">ğŸ—‘ï¸</span>*@
                    <span class="fm-btn-icon"><i class="fas fa-trash"></i></span>
                    Delete Selected
                </button>
            </div>
        </div>

        @if (ViewBag.Items != null && ((System.Collections.ICollection)ViewBag.Items).Count > 0)
        {
            <!-- Grid View (Default) -->
            <div class="fm-grid-view" id="gridView">
                @foreach (dynamic item in ViewBag.Items)
                {
                    <div class="fm-grid-item" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type" onclick="navigateToItem('@(item.Type == "Folder" ?
                                                                                                                                                                                                                                                                                                                                                                                                        Url.Action("Index", new { path = item.Path }) :
                                                                                                                                                                                                                                                                                                                                                                                                        Url.Action("Download", new { path = item.Path }))')">

                        <div class="fm-grid-checkbox-container fm-write-permission-only" onclick="event.stopPropagation();">
                            <div class="fm-grid-checkbox"></div>
                        </div>

                        <div class="fm-grid-item-icon fm-icon-@(item.Type == "Folder" ? "folder" : ((string)item.Extension).TrimStart('.'))">
                            @if (item.Type == "Folder")
                            {
                                // <text>ğŸ“</text>
                                <text><i class="fas fa-folder"></i></text>
                            }
                            else
                            {
                                @Html.Raw(GetFileIcon(item.Extension))
                            }
                        </div>
                        <div class="fm-grid-item-name" title="@item.Name">@item.Name</div>
                        @if (item.Type == "File")
                        {
                            <div class="fm-grid-item-info">@FormatFileSize(item.Size)</div>
                        }
                        else
                        {
                            <div class="fm-grid-item-info">Folder</div>
                        }
                    </div>
                }
            </div>

            <!-- List View (Hidden by default) -->
            <div class="fm-list-view" id="listView" style="display: none;">
                <div class="fm-list-header">
                    <!-- å…¨é€‰å¤é€‰æ¡† -->
                    <div class="fm-list-checkbox-container fm-write-permission-only" id="listSelectAllContainer">
                    </div>
                    <div></div>
                    <div>Name</div>
                    <div>Type</div>
                    <div>Size</div>
                    <div>Modified</div>
                    <div>Actions</div>
                </div>
                @foreach (dynamic item in ViewBag.Items)
                {
                    <!-- âœ… å”¯ä¸€ä¿®æ”¹ï¼šæ·»åŠ  fm-hidden ç±»ï¼Œé»˜è®¤éšè—æ‰€æœ‰é¡¹ï¼Œåˆ†é¡µä¼šæ˜¾ç¤ºå½“å‰é¡µ -->
                    <div class="fm-list-item fm-hidden" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type">
                        <div class="fm-list-checkbox-container fm-write-permission-only" onclick="event.stopPropagation();">
                            <div class="fm-list-checkbox"></div>
                        </div>
                        <div class="fm-list-icon fm-icon-@(item.Type == "Folder" ? "folder" : ((string)item.Extension).TrimStart('.'))"
                             onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <text><i class="fas fa-folder"></i></text>
                            }
                            else
                            {
                                @Html.Raw(GetFileIcon(item.Extension))
                            }
                        </div>
                        <div class="fm-list-name" title="@item.Name" onclick="navigateToItemByElement(this)">@item.Name</div>
                        <div class="fm-list-type" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <span class="fm-badge fm-badge-folder">Folder</span>
                            }
                            else
                            {
                                <span class="fm-badge fm-badge-file">@item.Extension</span>
                            }
                        </div>
                        <div class="fm-list-size" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "File")
                            {
                                @FormatFileSize(item.Size)
                            }
                            else
                            {
                                <text>â€”</text>
                            }
                        </div>
                        <div class="fm-list-date" onclick="navigateToItemByElement(this)">@(((DateTime)item.Modified).ToString("MMM dd, yyyy"))</div>
                        <div class="fm-list-actions" onclick="event.stopPropagation()">
                            @if (item.Type == "File")
                            {
                                <button class="fm-action-btn download-icon-btn" title="Download">
                                    <span class="fm-action-icon"><i class="fa-solid fa-download"></i></span>
                                </button>
                            }
                            else
                            {
                                <button class="fm-action-btn open-icon-btn" title="Open">
                                    <span class="fm-action-icon"><i class="fas fa-folder-open"></i></span>
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- åˆ†é¡µå®¹å™¨ï¼ˆæ”¾åœ¨æ–‡ä»¶åˆ—è¡¨ä¹‹åï¼‰ -->
            <div class="fm-pagination-wrapper" id="paginationWrapper" style="display: none;">
                <div class="fm-pagination-info" id="paginationInfo">
                    Showing 1-10 of 50 items
                </div>
                <ul class="fm-pagination" id="pagination">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </ul>
            </div>

            <!-- æœç´¢ç»“æœä¸ºç©ºçš„çŠ¶æ€ -->
            <div class="fm-empty-search" id="emptySearchState" style="display: none;">
                <div class="fm-empty-search-content">
                    <div class="fm-empty-search-icon">
                        <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="45" cy="45" r="30" stroke="currentColor" stroke-width="4" fill="none" opacity="0.3"/>
                            <line x1="67" y1="67" x2="85" y2="85" stroke="currentColor" stroke-width="4" stroke-linecap="round" opacity="0.3"/>
                            <path d="M45 35 L45 45 M35 45 L55 45" stroke="currentColor" stroke-width="3" stroke-linecap="round" opacity="0.5"/>
                        </svg>
                    </div>
                    <div class="fm-empty-search-text">No matching files or folders</div>
                    <div class="fm-empty-search-hint">Try adjusting your search terms or filters</div>
                    @*<button class="fm-btn fm-btn-secondary fm-clear-search-btn" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear Search
                    </button>*@
                </div>
            </div>
        }
        else
        {
            <div class="fm-empty">
                @*<div class="fm-empty-icon">ğŸ“‚</div>*@
                <div class="fm-empty-icon"><i class="fas fa-folder-open"></i></div>
                <div class="fm-empty-text">This folder is empty</div>
                <div class="fm-empty-hint">Drag files here or click Upload to add files</div>
            </div>
        }
    </div>
</div>

@functions {
    string GetFileIcon(string extension)
    {
        return extension?.ToLower() switch
        {
            ".doc" or ".docx" => "<i class='fas fa-file-word'></i>",
            ".xls" or ".xlsx" => "<i class='fas fa-file-excel'></i>",
            ".ppt" or ".pptx" => "<i class='fas fa-file-powerpoint'></i>",
            ".pdf" => "<i class='fas fa-file-pdf'></i>",
            ".txt" => "<i class='fas fa-file-alt'></i>",
            ".zip" or ".rar" or ".7z" => "<i class='fas fa-file-archive'></i>",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" => "<i class='fas fa-file-image'></i>",
            ".mp4" or ".avi" or ".mov" or ".wmv" => "<i class='fas fa-file-video'></i>",
            ".mp3" or ".wav" or ".flac" => "<i class='fas fa-file-audio'></i>",
            ".exe" => "<i class='fas fa-cog'></i>",
            ".html" or ".htm" => "<i class='fab fa-html5'></i>",
            ".css" => "<i class='fab fa-css3-alt'></i>",
            ".js" => "<i class='fab fa-js'></i>",
            ".json" => "<i class='fas fa-code'></i>",
            ".xml" => "<i class='fas fa-code'></i>",
            ".cs" => "<i class='fas fa-code'></i>",
            ".py" => "<i class='fab fa-python'></i>",
            ".java" => "<i class='fab fa-java'></i>",
            _ => "<i class='fas fa-file'></i>"
        };
    }

    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

<!-- åˆå§‹åŒ–è„šæœ¬ -->
<script>
     // ================= å…¨å±€å˜é‡ =================
    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;
    let currentSearchTerm = '';
    let allItems = [];
    let filteredItems = [];
    let currentViewMode = 'grid';

    // ================= List View ä¸“ç”¨å…¨å±€å˜é‡ =================
    window.listViewItems = [];
    window.listViewFilteredItems = [];
    window.listViewCurrentPage = 1;
    window.listViewSearchTerm = '';

    // ================= é¡µé¢åŠ è½½åˆå§‹åŒ– =================
    document.addEventListener('DOMContentLoaded', function() {
        // ========== è®¾ç½®å…¨å±€ç”¨æˆ·ä¿¡æ¯ ==========
        window.userDepartment = '@(ViewBag.UserDepartment ?? "Unknown")';
        window.userDisplayName = '@(ViewBag.UserDisplayName ?? "")';
        window.userRole = '@(ViewBag.UserRole ?? "User")';

        const relativePath = '@(ViewBag.RelativePath ?? "")';

        if (typeof initializeFileManager === 'function') {
            initializeFileManager(relativePath, '@Url.Action("Upload", "Home")');
        } else {
            showToast('Error', 'InitializeFileManager function not found!', 'error');
        }

        restoreViewMode();

        setTimeout(() => {
            if (typeof checkAndUpdateButtonsVisibility === 'function') {
                checkAndUpdateButtonsVisibility();
            }
        }, 100);

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                showLogoutModal();
            };
        }

        @if (ViewBag.Error != null)
        {
                <text>
                    setTimeout(() => {
                        showToast('Error', '@Html.Raw(ViewBag.Error)', 'error');
                    }, 1000);
                </text>
        }

        setTimeout(() => {
            if (typeof reattachGridEvents === 'function') {
                reattachGridEvents();
            }
            bindListViewEvents();
        }, 200);

        setTimeout(() => {
            console.log('ğŸ¯ åˆå§‹åŒ–åˆ†é¡µå’Œæœç´¢');
            const savedView = localStorage.getItem('spaceHSG_viewMode');
            if (savedView === 'list') {
                window.initializeListViewFeatures();
            } else {
                window.initializePaginationAndSearch();
            }
        }, 300);

        setupMobileSearchSync();
        initListSelection();
    });

    // ================= ğŸ”¥ åˆ—è¡¨è§†å›¾åˆå§‹åŒ–ï¼ˆæœ€ç»ˆä¿®å¤ç‰ˆï¼‰=================
    window.initializeListViewFeatures = function() {
        console.log('ğŸ”¥ åˆå§‹åŒ–åˆ—è¡¨è§†å›¾');

        const listItems = document.querySelectorAll('#listView .fm-list-item');
        console.log(`æ‰¾åˆ° ${listItems.length} ä¸ªåˆ—è¡¨é¡¹`);
        
        if (listItems.length === 0) {
            console.warn('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åˆ—è¡¨é¡¹ï¼');
            return;
        }

        window.listViewItems = [];
        listItems.forEach((item, index) => {
            // ğŸ”¥ å…³é”®ï¼šç§»é™¤ fm-hidden ç±»ï¼Œä½¿ç”¨å†…è”æ ·å¼æ§åˆ¶æ˜¾ç¤º
            item.classList.remove('fm-hidden');
            item.style.display = 'none';

            window.listViewItems.push({
                element: item,
                name: item.dataset.name || '',
                type: item.dataset.type || '',
                path: item.dataset.path || '',
                index: index
            });
        });

        console.log(`åˆå§‹åŒ–äº† ${window.listViewItems.length} ä¸ªåˆ—è¡¨è§†å›¾é¡¹ç›®`);
        window.listViewFilteredItems = [...window.listViewItems];
        console.log(`è¿‡æ»¤åçš„é¡¹ç›®æ•°é‡: ${window.listViewFilteredItems.length}`);

        // æ¢å¤çŠ¶æ€
        const savedSearch = localStorage.getItem('spaceHSG_listView_search');
        const savedPage = localStorage.getItem('spaceHSG_listView_page');

        window.listViewSearchTerm = savedSearch || '';
        window.listViewCurrentPage = savedPage ? parseInt(savedPage) : 1;
        console.log(`æ¢å¤çŠ¶æ€: æœç´¢è¯="${window.listViewSearchTerm}", å½“å‰é¡µ=${window.listViewCurrentPage}`);

        if (window.listViewSearchTerm) {
            const searchInput = document.getElementById('searchInput');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (searchInput) searchInput.value = window.listViewSearchTerm;
            if (mobileSearchInput) mobileSearchInput.value = window.listViewSearchTerm;
            console.log('æ‰§è¡Œæœç´¢...');
            performListViewSearch(window.listViewSearchTerm);
        } else {
            console.log('åº”ç”¨åˆ†é¡µ...');
            applyListViewPagination();
        }

        bindListViewSearch();
        updateSelectAllCheckbox();
        console.log('âœ… åˆ—è¡¨è§†å›¾åˆå§‹åŒ–å®Œæˆ');
    };


        // ================= ğŸ”¥ å®Œå…¨é‡å†™ï¼šåˆ—è¡¨è§†å›¾æœç´¢ =================
    function performListViewSearch(searchTerm) {
        console.log('æ‰§è¡Œåˆ—è¡¨è§†å›¾æœç´¢:', searchTerm);

        if (!searchTerm || searchTerm.trim() === '') {
            clearListViewSearch();
            return;
        }

        searchTerm = searchTerm.trim().toLowerCase();
        window.listViewSearchTerm = searchTerm;

        // ä¿å­˜æœç´¢è¯
        localStorage.setItem('spaceHSG_listView_search', searchTerm);

        // è¿‡æ»¤é¡¹ç›® - åªä¿ç•™åç§°åŒ…å«æœç´¢è¯çš„é¡¹ç›®
        window.listViewFilteredItems = window.listViewItems.filter(item => {
            return item.name.toLowerCase().includes(searchTerm);
        });

        console.log(`æ‰¾åˆ° ${window.listViewFilteredItems.length} ä¸ªåŒ¹é…é¡¹ç›®`);

        // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šå…ˆéšè—æ‰€æœ‰åˆ—è¡¨é¡¹
        document.querySelectorAll('#listView .fm-list-item').forEach(item => {
            item.style.display = 'none';
        });

        // å¦‚æœæ²¡æœ‰åŒ¹é…çš„é¡¹ç›®
        if (window.listViewFilteredItems.length === 0) {
            console.log('âš ï¸ æ²¡æœ‰åŒ¹é…ç»“æœ');
            // éšè—åˆ†é¡µ
            document.getElementById('paginationWrapper')?.style.setProperty('display', 'none', 'important');
            // æ˜¾ç¤ºç©ºçŠ¶æ€
            showListViewEmptyState(searchTerm);
            // æ˜¾ç¤ºæœç´¢ç»“æœä¿¡æ¯ï¼ˆ0ä¸ªç»“æœï¼‰
            showListViewSearchResults(searchTerm, 0);
            return;
        }

        // éšè—ç©ºçŠ¶æ€
        const emptyState = document.getElementById('emptySearchState');
        if (emptyState) emptyState.style.display = 'none';

        // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        window.listViewCurrentPage = 1;
        localStorage.setItem('spaceHSG_listView_page', 1);

        // é«˜äº®æœç´¢ç»“æœ
        highlightListViewSearch(searchTerm);

        // æ˜¾ç¤ºæœç´¢ç»“æœä¿¡æ¯
        showListViewSearchResults(searchTerm, window.listViewFilteredItems.length);

        // ğŸ”¥ ä¿®å¤ï¼šåº”ç”¨åˆ†é¡µï¼ˆä¼šè‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€é¡µçš„é¡¹ç›®ï¼‰
        applyListViewPagination();

        console.log('âœ… List View æœç´¢å®Œæˆ');
    }

    function clearListViewSearch() {
        console.log('ğŸ§¹ æ¸…é™¤ List View æœç´¢');
        
        window.listViewSearchTerm = '';
        window.listViewFilteredItems = [...window.listViewItems];

        // æ¸…é™¤ä¿å­˜çš„æœç´¢è¯
        localStorage.removeItem('spaceHSG_listView_search');

        // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        window.listViewCurrentPage = 1;
        localStorage.setItem('spaceHSG_listView_page', 1);

        // ğŸ”¥ éšè—ç©ºçŠ¶æ€æ¶ˆæ¯
        const emptyState = document.getElementById('emptySearchState');
        if (emptyState) {
            emptyState.style.display = 'none';
            console.log('âœ“ éšè—ç©ºçŠ¶æ€');
        }

        // åº”ç”¨åˆ†é¡µ
        applyListViewPagination();

        // ç§»é™¤é«˜äº®
        removeAllHighlights();

        // ç§»é™¤æœç´¢ç»“æœä¿¡æ¯
        document.getElementById('listViewSearchResults')?.remove();

        // æ¸…ç©ºæœç´¢æ¡†
        const searchInput = document.getElementById('searchInput');
        const mobileSearchInput = document.getElementById('mobileSearchInput');
        if (searchInput) searchInput.value = '';
        if (mobileSearchInput) mobileSearchInput.value = '';

        document.getElementById('searchClear')?.style.setProperty('display', 'none', 'important');
        document.getElementById('mobileSearchClear')?.style.setProperty('display', 'none', 'important');
        
        console.log('âœ… List View æœç´¢å·²æ¸…é™¤');
    }

    // ç§»é™¤æ‰€æœ‰é«˜äº®
    function removeAllHighlights() {
        document.querySelectorAll('.fm-list-name .fm-highlight, .fm-grid-item-name .fm-highlight').forEach(el => {
            const parent = el.parentNode;
            parent.replaceChild(document.createTextNode(el.textContent), el);
            parent.normalize();
        });
    }

    // ================= ğŸ”¥ åˆ—è¡¨è§†å›¾åˆ†é¡µï¼ˆæœ€ç»ˆä¿®å¤ç‰ˆï¼‰=================
    function applyListViewPagination() {
        console.log('ğŸ“„ åº”ç”¨åˆ—è¡¨è§†å›¾åˆ†é¡µ...');
        console.log(`è¿‡æ»¤åçš„é¡¹ç›®æ•°é‡: ${window.listViewFilteredItems ? window.listViewFilteredItems.length : 0}`);
        
        if (!window.listViewFilteredItems || window.listViewFilteredItems.length === 0) {
            console.warn('æ²¡æœ‰è¿‡æ»¤åçš„é¡¹ç›®ï¼Œéšè—æ‰€æœ‰é¡¹');
            document.querySelectorAll('#listView .fm-list-item').forEach(item => {
                item.style.display = 'none';
            });
            document.getElementById('paginationWrapper')?.style.setProperty('display', 'none', 'important');
            return;
        }

        const totalItems = window.listViewFilteredItems.length;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        console.log(`æ€»é¡¹ç›®æ•°: ${totalItems}, æ€»é¡µæ•°: ${totalPages}, å½“å‰é¡µ: ${window.listViewCurrentPage}`);

        if (window.listViewCurrentPage < 1) window.listViewCurrentPage = 1;
        if (window.listViewCurrentPage > totalPages) window.listViewCurrentPage = totalPages || 1;

        // éšè—æ‰€æœ‰é¡¹
        document.querySelectorAll('#listView .fm-list-item').forEach(item => {
            item.style.display = 'none';
        });

        // æ˜¾ç¤ºå½“å‰é¡µ
        const startIndex = (window.listViewCurrentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
        console.log(`æ˜¾ç¤ºé¡¹ç›® ${startIndex} åˆ° ${endIndex-1} (ç´¢å¼•)`);

        for (let i = startIndex; i < endIndex; i++) {
            if (window.listViewFilteredItems[i]?.element) {
                window.listViewFilteredItems[i].element.style.display = 'grid';
                console.log(`âœ“ æ˜¾ç¤ºé¡¹ç›® ${i}: ${window.listViewFilteredItems[i].name}`);
            } else {
                console.warn(`âœ— é¡¹ç›® ${i} ä¸å­˜åœ¨æˆ–æ²¡æœ‰ element`);
            }
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        console.log('æ›´æ–° List View åˆ†é¡µæ§ä»¶...');
        updateListViewPaginationControls(totalItems, totalPages);
        console.log('âœ… åˆ†é¡µåº”ç”¨å®Œæˆ');
    }

    // ================= ğŸ”¥ æ›´æ–°åˆ—è¡¨è§†å›¾åˆ†é¡µæ§ä»¶ =================
    function updateListViewPaginationControls(totalItems, totalPages) {
        console.log('ğŸ“Š updateListViewPaginationControls è¢«è°ƒç”¨:', totalItems, totalPages);
        const wrapper = document.getElementById('paginationWrapper');
        const info = document.getElementById('paginationInfo');
        const pagination = document.getElementById('pagination');

        if (!wrapper || !info || !pagination) {
            console.warn('åˆ†é¡µå…ƒç´ æœªæ‰¾åˆ°');
            return;
        }

        if (totalItems <= ITEMS_PER_PAGE) {
            console.log('é¡¹ç›®æ•°é‡ä¸è¶…è¿‡ä¸€é¡µï¼Œéšè—åˆ†é¡µ');
            wrapper.style.display = 'none';
            return;
        }

        console.log('æ˜¾ç¤ºåˆ†é¡µæ§ä»¶');
        wrapper.style.display = 'flex';

        const start = (window.listViewCurrentPage - 1) * ITEMS_PER_PAGE + 1;
        const end = Math.min(window.listViewCurrentPage * ITEMS_PER_PAGE, totalItems);
        info.textContent = `Showing ${start}-${end} of ${totalItems} items`;
        console.log(`åˆ†é¡µä¿¡æ¯: ${start}-${end} of ${totalItems}`);

        pagination.innerHTML = '';

        // ä¸Šä¸€é¡µ
        const prevBtn = createPaginationButton('prev', window.listViewCurrentPage === 1);
        if (window.listViewCurrentPage > 1) {
            prevBtn.onclick = (e) => {
                e.preventDefault();
                console.log('ç‚¹å‡»ä¸Šä¸€é¡µ');
                window.listViewCurrentPage--;
                localStorage.setItem('spaceHSG_listView_page', window.listViewCurrentPage);
                applyListViewPagination();
            };
        }
        pagination.appendChild(prevBtn);

        // ç¬¬ä¸€é¡µ
        if (window.listViewCurrentPage > 2) {
            pagination.appendChild(createPageButton(1));
        }

        // çœç•¥å·
        if (window.listViewCurrentPage > 3) {
            pagination.appendChild(createEllipsisButton());
        }

        // å½“å‰é¡µå‰ä¸€é¡µ
        if (window.listViewCurrentPage > 1) {
            pagination.appendChild(createPageButton(window.listViewCurrentPage - 1));
        }

        // å½“å‰é¡µ
        pagination.appendChild(createPageButton(window.listViewCurrentPage, true));

        // å½“å‰é¡µåä¸€é¡µ
        if (window.listViewCurrentPage < totalPages) {
            pagination.appendChild(createPageButton(window.listViewCurrentPage + 1));
        }

        // çœç•¥å·
        if (window.listViewCurrentPage < totalPages - 2) {
            pagination.appendChild(createEllipsisButton());
        }

        // æœ€åä¸€é¡µ
        if (window.listViewCurrentPage < totalPages - 1) {
            pagination.appendChild(createPageButton(totalPages));
        }

        // ä¸‹ä¸€é¡µ
        const nextBtn = createPaginationButton('next', window.listViewCurrentPage === totalPages);
        if (window.listViewCurrentPage < totalPages) {
            nextBtn.onclick = (e) => {
                e.preventDefault();
                console.log('ç‚¹å‡»ä¸‹ä¸€é¡µ');
                window.listViewCurrentPage++;
                localStorage.setItem('spaceHSG_listView_page', window.listViewCurrentPage);
                applyListViewPagination();
            };
        }
        pagination.appendChild(nextBtn);
        
        console.log('âœ… List View åˆ†é¡µæ§ä»¶æ›´æ–°å®Œæˆ');
    }

    // ================= ğŸ”¥ è¾…åŠ©å‡½æ•°åŒºåŸŸï¼ˆç”¨äºåˆ†é¡µæŒ‰é’®ï¼‰=================
    function createPageButton(pageNum, isActive = false) {
        console.log(`åˆ›å»ºé¡µç æŒ‰é’®: ${pageNum}, æ¿€æ´»: ${isActive}`);
        const btn = document.createElement('li');
        btn.className = `fm-page-item ${isActive ? 'active' : ''}`;
        btn.innerHTML = `<a class="fm-page-link" href="#">${pageNum}</a>`;
        btn.onclick = (e) => {
            e.preventDefault();
            console.log(`ç‚¹å‡»é¡µç : ${pageNum}`);
            window.listViewCurrentPage = pageNum;
            localStorage.setItem('spaceHSG_listView_page', pageNum);
            applyListViewPagination();
        };
        return btn;
    }

    // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºçœç•¥å·
    function createEllipsisButton() {
        const ellipsis = document.createElement('li');
        ellipsis.className = 'fm-page-item disabled';
        ellipsis.innerHTML = `<span class="fm-page-link">...</span>`;
        return ellipsis;
    }

    // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®
    function createPaginationButton(type, isDisabled) {
        console.log(`åˆ›å»ºå¯¼èˆªæŒ‰é’®: ${type}, ç¦ç”¨: ${isDisabled}`);
        const button = document.createElement('li');
        button.className = `fm-page-item ${isDisabled ? 'disabled' : ''}`;

        if (type === 'prev') {
            button.innerHTML = `<a class="fm-page-link" href="#" aria-label="Previous"><i class="fas fa-chevron-left"></i></a>`;
        } else {
            button.innerHTML = `<a class="fm-page-link" href="#" aria-label="Next"><i class="fas fa-chevron-right"></i></a>`;
        }

        return button;
    }

    // ================= ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºåˆ—è¡¨è§†å›¾åˆ†é¡µæ§ä»¶ =================
    function showListViewPagination() {
        const paginationWrapper = document.getElementById('paginationWrapper');
        const paginationInfo = document.getElementById('paginationInfo');
        const pagination = document.getElementById('pagination');

        if (!paginationWrapper || !paginationInfo || !pagination) return;

        const totalItems = window.listViewFilteredItems ? window.listViewFilteredItems.length : 0;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

        if (totalItems <= ITEMS_PER_PAGE) {
            paginationWrapper.style.display = 'none';
            return;
        }

        paginationWrapper.style.display = 'flex';

        const start = (window.listViewCurrentPage - 1) * ITEMS_PER_PAGE + 1;
        const end = Math.min(window.listViewCurrentPage * ITEMS_PER_PAGE, totalItems);
        paginationInfo.textContent = `Showing ${start}-${end} of ${totalItems} items`;

        // ç”Ÿæˆåˆ†é¡µæŒ‰é’®
        pagination.innerHTML = '';

        // ä¸Šä¸€é¡µ
        const prevButton = document.createElement('li');
        prevButton.className = `fm-page-item ${window.listViewCurrentPage === 1 ? 'disabled' : ''}`;
        prevButton.innerHTML = `<a class="fm-page-link" href="#" aria-label="Previous"><i class="fas fa-chevron-left"></i></a>`;
        prevButton.onclick = (e) => {
            e.preventDefault();
            if (window.listViewCurrentPage > 1) {
                window.listViewCurrentPage--;
                showListViewPage(window.listViewCurrentPage);
                showListViewPagination();
                localStorage.setItem('spaceHSG_listView_page', window.listViewCurrentPage);
            }
        };
        pagination.appendChild(prevButton);

        // é¡µç æŒ‰é’®
        const maxVisiblePages = 5;
        let startPage = Math.max(1, window.listViewCurrentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
            const firstPageButton = document.createElement('li');
            firstPageButton.className = 'fm-page-item';
            firstPageButton.innerHTML = `<a class="fm-page-link" href="#">1</a>`;
            firstPageButton.onclick = (e) => {
                e.preventDefault();
                window.listViewCurrentPage = 1;
                showListViewPage(1);
                showListViewPagination();
                localStorage.setItem('spaceHSG_listView_page', 1);
            };
            pagination.appendChild(firstPageButton);

            if (startPage > 2) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'fm-page-item disabled';
                ellipsis.innerHTML = `<span class="fm-page-link">...</span>`;
                pagination.appendChild(ellipsis);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('li');
            pageButton.className = `fm-page-item ${i === window.listViewCurrentPage ? 'active' : ''}`;
            pageButton.innerHTML = `<a class="fm-page-link" href="#">${i}</a>`;
            pageButton.onclick = (e) => {
                e.preventDefault();
                window.listViewCurrentPage = i;
                showListViewPage(i);
                showListViewPagination();
                localStorage.setItem('spaceHSG_listView_page', i);
            };
            pagination.appendChild(pageButton);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'fm-page-item disabled';
                ellipsis.innerHTML = `<span class="fm-page-link">...</span>`;
                pagination.appendChild(ellipsis);
            }

            const lastPageButton = document.createElement('li');
            lastPageButton.className = 'fm-page-item';
            lastPageButton.innerHTML = `<a class="fm-page-link" href="#">${totalPages}</a>`;
            lastPageButton.onclick = (e) => {
                e.preventDefault();
                window.listViewCurrentPage = totalPages;
                showListViewPage(totalPages);
                showListViewPagination();
                localStorage.setItem('spaceHSG_listView_page', totalPages);
            };
            pagination.appendChild(lastPageButton);
        }

        // ä¸‹ä¸€é¡µ
        const nextButton = document.createElement('li');
        nextButton.className = `fm-page-item ${window.listViewCurrentPage === totalPages ? 'disabled' : ''}`;
        nextButton.innerHTML = `<a class="fm-page-link" href="#" aria-label="Next"><i class="fas fa-chevron-right"></i></a>`;
        nextButton.onclick = (e) => {
            e.preventDefault();
            if (window.listViewCurrentPage < totalPages) {
                window.listViewCurrentPage++;
                showListViewPage(window.listViewCurrentPage);
                showListViewPagination();
                localStorage.setItem('spaceHSG_listView_page', window.listViewCurrentPage);
            }
        };
        pagination.appendChild(nextButton);
    }




    // ================= ğŸ”¥ æ–°å¢ï¼šåˆ—è¡¨è§†å›¾æœç´¢é«˜äº® =================
    function highlightListViewSearch(searchTerm) {
        if (!searchTerm) return;

        // ç§»é™¤å·²æœ‰çš„é«˜äº®
        document.querySelectorAll('.fm-list-name .fm-highlight').forEach(el => {
            const parent = el.parentNode;
            parent.replaceChild(document.createTextNode(el.textContent), el);
            parent.normalize();
        });

        // ä¸ºåŒ¹é…çš„é¡¹ç›®æ·»åŠ é«˜äº®
        window.listViewFilteredItems.forEach(item => {
            if (item.element) {
                const nameElement = item.element.querySelector('.fm-list-name');
                if (nameElement) {
                    const originalText = nameElement.textContent || nameElement.innerText;
                    const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
                    if (regex.test(originalText)) {
                        const highlightedText = originalText.replace(regex, '<span class="fm-highlight">$1</span>');
                        nameElement.innerHTML = highlightedText;
                    }
                }
            }
        });
    }

    // ================= ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºåˆ—è¡¨è§†å›¾æœç´¢ç»“æœä¿¡æ¯ =================
    function showListViewSearchResults(searchTerm, resultCount) {
        const oldInfo = document.getElementById('listViewSearchResults');
        if (oldInfo) oldInfo.remove();

        if (!searchTerm) return;

        const infoElement = document.createElement('div');
        infoElement.id = 'listViewSearchResults';
        infoElement.className = 'fm-search-results-info';
        infoElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-gray); border-radius: 6px; margin: 10px 0;">
                <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                <span style="color: var(--text-primary); font-weight: 500;">Search results for "${searchTerm}"</span>
                <span style="color: var(--text-secondary); margin-left: auto;">${resultCount} items found</span>
                <button onclick="clearListViewSearch()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    Clear <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        const filesContainer = document.querySelector('.fm-files-container');
        if (filesContainer) {
            filesContainer.parentNode.insertBefore(infoElement, filesContainer);
        }
    }

    // ================= ğŸ”¥ æ–°å¢ï¼šç»‘å®šåˆ—è¡¨è§†å›¾æœç´¢äº‹ä»¶ =================
    function bindListViewSearch() {
        console.log('ğŸ”§ ç»‘å®š List View æœç´¢äº‹ä»¶');
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');

        if (searchInput) {
            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç§»é™¤ HTML ä¸­çš„ onkeyup å±æ€§ï¼Œé¿å…ä¸ addEventListener å†²çª
            searchInput.removeAttribute('onkeyup');
            
            // ç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);

            // ç¡®ä¿å…‹éš†åä¹Ÿæ²¡æœ‰ onkeyup å±æ€§
            newSearchInput.removeAttribute('onkeyup');
            newSearchInput.id = 'searchInput';
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            newSearchInput.addEventListener('input', function() {
                console.log('ğŸ” List View Search input changed:', this.value);
                
                const searchClear = document.getElementById('searchClear');
                if (searchClear) {
                    searchClear.style.display = this.value ? 'block' : 'none';
                }

                if (this.value.trim() === '') {
                    clearListViewSearch();
                } else {
                    performListViewSearch(this.value.trim());
                }
            });

            newSearchInput.addEventListener('keyup', function(e) {
                console.log('ğŸ” List View Search keyup:', e.key, this.value);
                if (e.key === 'Enter') {
                    if (this.value.trim() === '') {
                        clearListViewSearch();
                    } else {
                        performListViewSearch(this.value.trim());
                    }
                }
            });

            // æ¢å¤æœç´¢è¯
            if (window.listViewSearchTerm) {
                newSearchInput.value = window.listViewSearchTerm;
                console.log('æ¢å¤æœç´¢è¯:', window.listViewSearchTerm);
            }
            
            console.log('âœ… List View æœç´¢äº‹ä»¶ç»‘å®šå®Œæˆ');
        }

        // ä¿®å¤æœç´¢æ¸…é™¤æŒ‰é’®
        if (searchClear) {
            searchClear.onclick = function() {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.value = '';
                this.style.display = 'none';

                if (isCurrentViewList()) {
                    clearListViewSearch();
                } else {
                    window.clearSearch();
                }
            };
        }
    }

    // ================= åˆå§‹åŒ–åˆ—è¡¨è§†å›¾é€‰æ‹©åŠŸèƒ½ =================
    function initListSelection() {
        // ä¸ºåˆ—è¡¨è§†å›¾å¤´éƒ¨çš„å…¨é€‰å®¹å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const listSelectAllContainer = document.getElementById('listSelectAllContainer');
        if (listSelectAllContainer) {
            listSelectAllContainer.onclick = function(e) {
                e.stopPropagation();
                toggleSelectAll();
            };
        }

        // ä¸ºæ‰€æœ‰åˆ—è¡¨é¡¹å¤é€‰æ¡†æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('#listView .fm-list-checkbox-container').forEach(container => {
            const checkbox = container.querySelector('.fm-list-checkbox');
            if (checkbox) {
                checkbox.onclick = function(e) {
                    e.stopPropagation();
                    toggleListItemSelection(this);
                };
            }
        });
    }

    // ================= ç»‘å®šåˆ—è¡¨è§†å›¾äº‹ä»¶ =================
    function bindListViewEvents() {
        // ç»‘å®šåˆ—è¡¨é¡¹ç‚¹å‡»äº‹ä»¶ï¼ˆå¯¼èˆªï¼‰
        document.querySelectorAll('#listView .fm-list-item').forEach(item => {
            // ç§»é™¤åŸæœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤
            item.removeEventListener('click', handleListItemClick);
            item.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ã€æ“ä½œæŒ‰é’®æˆ–å®ƒä»¬çš„çˆ¶å…ƒç´ ï¼Œä¸è§¦å‘å¯¼èˆª
                if (e.target.closest('.fm-list-checkbox-container') ||
                    e.target.closest('.fm-list-actions') ||
                    e.target.closest('.fm-action-btn')) {
                    return;
                }
                handleListItemClick.call(this, e);
            });
        });

        // ç»‘å®šåˆ—è¡¨è§†å›¾ä¸­çš„å¯¼èˆªå…ƒç´ 
        document.querySelectorAll('#listView .fm-list-icon, #listView .fm-list-name, #listView .fm-list-type, #listView .fm-list-size, #listView .fm-list-date').forEach(el => {
            el.removeEventListener('click', navigateToItemByElement);
            el.addEventListener('click', navigateToItemByElement);
        });

        // ç»‘å®šæ“ä½œæŒ‰é’®
        bindListActionButtons();
    }

    // ================= ç»‘å®šåˆ—è¡¨è§†å›¾æ“ä½œæŒ‰é’® =================
    function bindListActionButtons() {
        // ä¸‹è½½æŒ‰é’®
        document.querySelectorAll('#listView .download-icon-btn').forEach(btn => {
            btn.onclick = function(e) {
                e.stopPropagation();
                const listItem = this.closest('.fm-list-item');
                if (listItem) {
                    const path = listItem.dataset.path;
                    if (path) {
                        window.location.href = '@Url.Action("Download", "Home")?path=' + encodeURIComponent(path);
                    }
                }
            };
        });

        // æ‰“å¼€æ–‡ä»¶å¤¹æŒ‰é’®
        document.querySelectorAll('#listView .open-icon-btn').forEach(btn => {
            btn.onclick = function(e) {
                e.stopPropagation();
                const listItem = this.closest('.fm-list-item');
                if (listItem) {
                    const path = listItem.dataset.path;
                    if (path) {
                        window.location.href = '@Url.Action("Index", "Home")?path=' + encodeURIComponent(path);
                    }
                }
            };
        });

        // åˆ é™¤æŒ‰é’®ï¼ˆå¦‚æœæœ‰ï¼‰
        document.querySelectorAll('#listView .delete-icon-btn').forEach(btn => {
            btn.onclick = function(e) {
                e.stopPropagation();
                const listItem = this.closest('.fm-list-item');
                if (listItem) {
                    const name = listItem.dataset.name;
                    const path = listItem.dataset.path;
                    if (name && path && typeof showDeleteModal === 'function') {
                        showDeleteModal(name, path);
                    }
                }
            };
        });
    }

    // ================= å¤„ç†åˆ—è¡¨é¡¹ç‚¹å‡» =================
    function handleListItemClick(e) {
        const listItem = this.closest('.fm-list-item');
        if (!listItem) return;

        const path = listItem.dataset.path;
        const type = listItem.dataset.type;

        if (path && type) {
            if (type === 'Folder') {
                window.location.href = '@Url.Action("Index", "Home")?path=' + encodeURIComponent(path);
            } else {
                window.location.href = '@Url.Action("Download", "Home")?path=' + encodeURIComponent(path);
            }
        }
    }

    // ================= åˆ‡æ¢åˆ—è¡¨é¡¹é€‰æ‹© =================
    window.toggleListItemSelection = function(checkboxElement) {
        if (!checkboxElement) return;

        checkboxElement.classList.toggle('selected');

        const listItem = checkboxElement.closest('.fm-list-item');
        if (listItem) {
            if (checkboxElement.classList.contains('selected')) {
                listItem.classList.add('selected');
            } else {
                listItem.classList.remove('selected');
            }
        }

        updateBatchActionsVisibility();
        updateSelectAllCheckbox();
    };

    // ================= åˆ‡æ¢ç½‘æ ¼é¡¹é€‰æ‹© =================
    window.toggleGridItemSelection = function(checkboxElement) {
        if (!checkboxElement) return;

        checkboxElement.classList.toggle('selected');

        const gridItem = checkboxElement.closest('.fm-grid-item');
        if (gridItem) {
            if (checkboxElement.classList.contains('selected')) {
                gridItem.classList.add('selected');
            } else {
                gridItem.classList.remove('selected');
            }
        }

        updateBatchActionsVisibility();
        updateSelectAllCheckbox();
    };

    // ================= åˆ‡æ¢å…¨é€‰ =================
    window.toggleSelectAll = function() {
        const isListView = isCurrentViewList();
        let allCheckboxes;
        let allSelected = false;

        if (isListView) {
            allCheckboxes = document.querySelectorAll('#listView .fm-list-checkbox-container .fm-list-checkbox');
        } else {
            allCheckboxes = document.querySelectorAll('#gridView .fm-grid-checkbox-container .fm-grid-checkbox');
        }

        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å·²é€‰ä¸­
        allSelected = Array.from(allCheckboxes).every(cb => cb.classList.contains('selected'));

        // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
        allCheckboxes.forEach(checkbox => {
            if (allSelected) {
                checkbox.classList.remove('selected');
                const item = checkbox.closest(isListView ? '.fm-list-item' : '.fm-grid-item');
                if (item) item.classList.remove('selected');
            } else {
                checkbox.classList.add('selected');
                const item = checkbox.closest(isListView ? '.fm-list-item' : '.fm-grid-item');
                if (item) item.classList.add('selected');
            }
        });

        // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
        const selectAllHeader = document.getElementById('selectAllHeader');
        if (selectAllHeader) {
            if (!allSelected) {
                selectAllHeader.classList.add('selected');
            } else {
                selectAllHeader.classList.remove('selected');
            }
        }

        updateBatchActionsVisibility();
    };

    // ================= æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€ =================
    function updateSelectAllCheckbox() {
        const isListView = isCurrentViewList();
        let allCheckboxes;
        let selectedCheckboxes;

        if (isListView) {
            allCheckboxes = document.querySelectorAll('#listView .fm-list-checkbox-container .fm-list-checkbox');
            selectedCheckboxes = document.querySelectorAll('#listView .fm-list-checkbox-container .fm-list-checkbox.selected');
        } else {
            allCheckboxes = document.querySelectorAll('#gridView .fm-grid-checkbox-container .fm-grid-checkbox');
            selectedCheckboxes = document.querySelectorAll('#gridView .fm-grid-checkbox-container .fm-grid-checkbox.selected');
        }

        const selectAllHeader = document.getElementById('selectAllHeader');
        if (selectAllHeader) {
            if (allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length) {
                selectAllHeader.classList.add('selected');
            } else {
                selectAllHeader.classList.remove('selected');
            }
        }

        // æ›´æ–°åˆ—è¡¨è§†å›¾å¤´éƒ¨çš„å…¨é€‰å®¹å™¨çŠ¶æ€
        if (isListView) {
            const listSelectAllContainer = document.getElementById('listSelectAllContainer');
            if (listSelectAllContainer) {
                const selectAllCheckbox = listSelectAllContainer.querySelector('.fm-list-checkbox');
                if (selectAllCheckbox) {
                    if (allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length) {
                        selectAllCheckbox.classList.add('selected');
                    } else {
                        selectAllCheckbox.classList.remove('selected');
                    }
                }
            }
        }
    }

    // ================= æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®å¯è§æ€§ =================
    function updateBatchActionsVisibility() {
        const isListView = isCurrentViewList();
        let selectedCount = 0;

        if (isListView) {
            selectedCount = document.querySelectorAll('#listView .fm-list-checkbox-container .fm-list-checkbox.selected').length;
        } else {
            selectedCount = document.querySelectorAll('#gridView .fm-grid-checkbox-container .fm-grid-checkbox.selected').length;
        }

        const batchActions = document.getElementById('batchActions');
        const selectedNumber = document.getElementById('selectedNumber');
        const batchDeleteBtn = document.getElementById('batchDeleteBtn');

        if (selectedCount > 0) {
            if (batchActions) batchActions.style.display = 'flex';
            if (selectedNumber) selectedNumber.textContent = selectedCount;
        } else {
            if (batchActions) batchActions.style.display = 'none';
        }

        // ç»‘å®šæ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶
        if (batchDeleteBtn && selectedCount > 0) {
            batchDeleteBtn.onclick = function() {
                const count = selectedCount;
                if (typeof showBatchDeleteModal === 'function') {
                    showBatchDeleteModal(count);
                }
            };
        }
    }

    // ================= åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºåˆ—è¡¨è§†å›¾ =================
    function isCurrentViewList() {
        const savedView = localStorage.getItem('spaceHSG_viewMode');
        if (savedView) {
            return savedView === 'list';
        }

        const listView = document.getElementById('listView');
        if (listView) {
            const display = window.getComputedStyle(listView).display;
            return display !== 'none';
        }
        return false;
    }

        // ================= æ¢å¤è§†å›¾æ¨¡å¼å’Œåˆ†é¡µçŠ¶æ€ =================
    function restoreViewMode() {
        const savedView = localStorage.getItem('spaceHSG_viewMode');

        // å¼ºåˆ¶ä» localStorage è¯»å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º grid
        currentViewMode = savedView === 'list' ? 'list' : 'grid';

        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');
        const viewGridBtn = document.getElementById('viewGrid');
        const viewListBtn = document.getElementById('viewList');

        if (!gridView || !listView) return;

        // æ ¹æ®ä¿å­˜çš„è§†å›¾æ¨¡å¼æ˜¾ç¤º/éšè—
        if (currentViewMode === 'list') {
            gridView.style.display = 'none';
            listView.style.display = 'flex';
            viewGridBtn?.classList.remove('active');
            viewListBtn?.classList.add('active');
        } else {
            gridView.style.display = 'grid';
            listView.style.display = 'none';
            viewGridBtn?.classList.add('active');
            viewListBtn?.classList.remove('active');
        }

        // ç¡®ä¿ localStorage ä¸­çš„å€¼æ­£ç¡®
        localStorage.setItem('spaceHSG_viewMode', currentViewMode);

        console.log('è§†å›¾æ¨¡å¼æ¢å¤ä¸º:', currentViewMode);
    }

        // ================= è§†å›¾åˆ‡æ¢å‡½æ•°ï¼ˆæ— åˆ·æ–°ï¼‰=================
    window.switchView = function(viewType) {
        // å¦‚æœå·²ç»æ˜¯å½“å‰è§†å›¾ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        if (currentViewMode === viewType) return;

        // æ›´æ–°å½“å‰è§†å›¾æ¨¡å¼
        currentViewMode = viewType;

        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('spaceHSG_viewMode', viewType);

        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');
        const viewGridBtn = document.getElementById('viewGrid');
        const viewListBtn = document.getElementById('viewList');

        // åˆ‡æ¢è§†å›¾æ˜¾ç¤º
        if (viewType === 'list') {
            gridView.style.display = 'none';
            listView.style.display = 'flex';
            viewGridBtn?.classList.remove('active');
            viewListBtn?.classList.add('active');

            // åˆå§‹åŒ–åˆ—è¡¨è§†å›¾
            setTimeout(() => {
                window.initializeListViewFeatures();
            }, 50);
        } else {
            gridView.style.display = 'grid';
            listView.style.display = 'none';
            viewGridBtn?.classList.add('active');
            viewListBtn?.classList.remove('active');

            // åˆå§‹åŒ–ç½‘æ ¼è§†å›¾
            setTimeout(() => {
                window.initializePaginationAndSearch();
            }, 50);
        }

        showToast('View Switched', `Switched to ${viewType} view`, 'success');
    };

        // ================= åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ï¼ˆä¿ç•™å½“å‰è§†å›¾ï¼‰=================
    window.refreshFileListWithoutReload = function() {
        showToast('Refreshing', 'Updating file list...', 'info');

        // ä¿å­˜å½“å‰è§†å›¾å’ŒçŠ¶æ€
        const currentView = localStorage.getItem('spaceHSG_viewMode') || 'grid';
        const currentPageToSave = currentView === 'list'
            ? (window.listViewCurrentPage || 1)
            : (currentPage || 1);
        const searchTermToSave = currentView === 'list'
            ? (window.listViewSearchTerm || '')
            : (currentSearchTerm || '');

        const currentPath = window.location.pathname;
        const searchParams = new URLSearchParams(window.location.search);
        const path = searchParams.get('path') || '';

        fetch(`${currentPath}?path=${encodeURIComponent(path)}&ajax=true`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const oldFilesContainer = document.querySelector('.fm-files-container');
            const newFilesContainer = doc.querySelector('.fm-files-container');

            if (oldFilesContainer && newFilesContainer) {
                oldFilesContainer.innerHTML = newFilesContainer.innerHTML;
            }

            // å¼ºåˆ¶æ¢å¤è§†å›¾æ¨¡å¼
            setTimeout(() => {
                // æ¢å¤è§†å›¾
                if (currentView === 'list') {
                    document.getElementById('gridView')?.style.setProperty('display', 'none', 'important');
                    document.getElementById('listView')?.style.setProperty('display', 'flex', 'important');
                    document.getElementById('viewGrid')?.classList.remove('active');
                    document.getElementById('viewList')?.classList.add('active');

                    // é‡æ–°åˆå§‹åŒ–åˆ—è¡¨è§†å›¾
                    window.initializeListViewFeatures();

                    // æ¢å¤æœç´¢å’Œé¡µç 
                    if (searchTermToSave) {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            searchInput.value = searchTermToSave;
                            performListViewSearch(searchTermToSave);
                        }
                    } else {
                        window.listViewCurrentPage = currentPageToSave;
                        applyListViewPagination();
                    }
                } else {
                    document.getElementById('gridView')?.style.setProperty('display', 'grid', 'important');
                    document.getElementById('listView')?.style.setProperty('display', 'none', 'important');
                    document.getElementById('viewGrid')?.classList.add('active');
                    document.getElementById('viewList')?.classList.remove('active');

                    // é‡æ–°åˆå§‹åŒ–ç½‘æ ¼è§†å›¾
                    window.initializePaginationAndSearch();

                    // æ¢å¤æœç´¢å’Œé¡µç 
                    if (searchTermToSave) {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            searchInput.value = searchTermToSave;
                            performSearch(searchTermToSave);
                        }
                    } else {
                        currentPage = currentPageToSave;
                        showPage(currentPage);
                    }
                }

                // é‡æ–°ç»‘å®šäº‹ä»¶
                reattachGridEvents();
                bindListViewEvents();
                initListSelection();

                showToast('Success', 'File list updated', 'success');
            }, 100);
        })
        .catch(error => {
            console.error('Refresh failed:', error);
            showToast('Error', 'Failed to refresh file list', 'error');
        });
    };

    // ================= åˆ·æ–°åé‡æ–°åˆå§‹åŒ– =================
    function reinitializeAfterRefresh() {
        if (typeof reattachGridEvents === 'function') {
            reattachGridEvents();
        }

        reinitializeCheckboxes();
        refreshItemsData();

        // âœ… é‡æ–°åˆå§‹åŒ–åˆ—è¡¨è§†å›¾åŠŸèƒ½
        initListSelection();
        bindListViewEvents();

        setupMobileSearchSync();

        setTimeout(() => {
            if (isCurrentViewList()) {
                // ğŸ”¥ åˆ—è¡¨è§†å›¾ï¼šä¸è¦è°ƒç”¨ç½‘æ ¼è§†å›¾çš„åˆ†é¡µåˆå§‹åŒ–
                console.log('åˆ·æ–°åé‡æ–°åˆå§‹åŒ–åˆ—è¡¨è§†å›¾åŠŸèƒ½');
                // initializeListViewFeatures() ä¼šåœ¨ refreshFileListWithoutReload ä¸­è°ƒç”¨
            } else {
                window.initializePaginationAndSearch();
            }
        }, 100);
    }

    // ================= é‡æ–°åˆå§‹åŒ–å¤é€‰æ¡† =================
    function reinitializeCheckboxes() {
        // ç½‘æ ¼è§†å›¾å¤é€‰æ¡†
        document.querySelectorAll('.fm-grid-checkbox-container').forEach(container => {
            const checkbox = container.querySelector('.fm-grid-checkbox');
            if (checkbox) {
                checkbox.onclick = function(e) {
                    e.stopPropagation();
                    toggleGridItemSelection(this);
                };
            }
        });

        // åˆ—è¡¨è§†å›¾å¤é€‰æ¡†
        document.querySelectorAll('.fm-list-checkbox-container').forEach(container => {
            const checkbox = container.querySelector('.fm-list-checkbox');
            if (checkbox) {
                checkbox.onclick = function(e) {
                    e.stopPropagation();
                    toggleListItemSelection(this);
                };
            }
        });
    }

    // ================= åˆ·æ–°é¡¹ç›®æ•°æ® =================
    function refreshItemsData() {
        allItems = [];
        filteredItems = [];
        allItems = getAllItems();
        filteredItems = [...allItems];
    }

    // ================= è·å–æ‰€æœ‰é¡¹ç›®æ•°æ® =================
    function getAllItems() {
        const items = [];
        const isListView = isCurrentViewList();

        let activeItems = [];
        if (isListView) {
            activeItems = document.querySelectorAll('#listView .fm-list-item');
        } else {
            activeItems = document.querySelectorAll('#gridView .fm-grid-item');
        }

        // è½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„
        activeItems.forEach(item => {
            items.push({
                element: item,
                name: item.dataset.name || '',
                type: item.dataset.type || '',
                path: item.dataset.path || '',
                isVisible: !item.classList.contains('fm-hidden') && item.style.display !== 'none'
            });
        });

        return items;
    }

    // ================= ç»Ÿä¸€åˆ†é¡µåŠŸèƒ½ï¼ˆä»…ä¾›ç½‘æ ¼è§†å›¾ä½¿ç”¨ï¼‰=================
    function updatePagination() {
        // ğŸ”¥ å¦‚æœæ˜¯åˆ—è¡¨è§†å›¾ï¼Œä¸æ‰§è¡Œç½‘æ ¼è§†å›¾çš„åˆ†é¡µé€»è¾‘
        if (isCurrentViewList()) {
            return;
        }

        console.log('ğŸ“„ æ›´æ–°ç½‘æ ¼è§†å›¾åˆ†é¡µ');
        
        const paginationWrapper = document.getElementById('paginationWrapper');
        const pagination = document.getElementById('pagination');
        const paginationInfo = document.getElementById('paginationInfo');

        // ğŸ”¥ ä¿®å¤ï¼šä¸è°ƒç”¨ refreshItemsDataï¼Œå› ä¸º filteredItems å·²ç»åœ¨ performSearch ä¸­è®¾ç½®å¥½äº†
        // refreshItemsData();

        if (!filteredItems || filteredItems.length === 0) {
            console.log('æ²¡æœ‰è¿‡æ»¤é¡¹ï¼Œéšè—åˆ†é¡µ');
            if (paginationWrapper) paginationWrapper.style.display = 'none';
            
            // ğŸ”¥ ç¡®ä¿éšè—æ‰€æœ‰ç½‘æ ¼é¡¹
            document.querySelectorAll('#gridView .fm-grid-item').forEach(item => {
                item.style.display = 'none';
            });
            return;
        }

        const totalItems = filteredItems.length;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        console.log(`æ€»é¡¹æ•°: ${totalItems}, æ€»é¡µæ•°: ${totalPages}`);

        if (totalPages <= 1) {
            console.log('åªæœ‰ä¸€é¡µï¼Œéšè—åˆ†é¡µæ§ä»¶');
            if (paginationWrapper) paginationWrapper.style.display = 'none';
            // ä¸éœ€è¦åœ¨è¿™é‡Œæ˜¾ç¤ºé¡¹ç›®ï¼Œè°ƒç”¨è€…ä¼šå¤„ç†
            return;
        }

        // è°ƒç”¨ updatePaginationControls æ¥æ›´æ–°åˆ†é¡µUI
        console.log('è°ƒç”¨ updatePaginationControls');
        updatePaginationControls();
    }

    // ================= æ˜¾ç¤ºé¡µç å†…å®¹ï¼ˆä»…ä¾›ç½‘æ ¼è§†å›¾ä½¿ç”¨ï¼‰=================
    function showPage(page) {
        // ğŸ”¥ å¦‚æœæ˜¯åˆ—è¡¨è§†å›¾ï¼Œä¸æ‰§è¡Œç½‘æ ¼è§†å›¾çš„åˆ†é¡µé€»è¾‘
        if (isCurrentViewList()) {
            return;
        }

        console.log(`ğŸ“„ æ˜¾ç¤ºç½‘æ ¼è§†å›¾ç¬¬ ${page} é¡µ`);
        currentPage = page;

        // ğŸ”¥ ä¿®å¤ï¼šä¸è°ƒç”¨ refreshItemsDataï¼Œä¿æŒå½“å‰çš„ filteredItems
        // refreshItemsData();

        if (!filteredItems || filteredItems.length === 0) {
            console.log('æ²¡æœ‰è¿‡æ»¤é¡¹ï¼Œä½¿ç”¨æ‰€æœ‰é¡¹');
            filteredItems = [...allItems];
        }

        if (filteredItems.length === 0) {
            console.log('æ²¡æœ‰é¡¹ç›®å¯æ˜¾ç¤º');
            return;
        }

        const startIndex = (page - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredItems.length);
        console.log(`æ˜¾ç¤ºé¡¹ç›® ${startIndex} åˆ° ${endIndex-1} (ç´¢å¼•)`);

        // 1. å…ˆéšè—æ‰€æœ‰ç½‘æ ¼é¡¹ç›®
        document.querySelectorAll('#gridView .fm-grid-item').forEach(item => {
            item.style.display = 'none';
        });

        // 2. æ˜¾ç¤ºå½“å‰é¡µçš„é¡¹ç›®
        for (let i = startIndex; i < endIndex; i++) {
            if (filteredItems[i] && filteredItems[i].element) {
                filteredItems[i].element.style.display = '';
                console.log(`âœ“ æ˜¾ç¤º: ${filteredItems[i].name}`);
            }
        }

        // 3. æ›´æ–°åˆ†é¡µæ§ä»¶ï¼ˆä¸ä¼šé€’å½’è°ƒç”¨ showPageï¼‰
        updatePaginationControls();

        console.log(`âœ… ç¬¬ ${page} é¡µæ˜¾ç¤ºå®Œæˆ`);
    }
    
    // ================= åªæ›´æ–°åˆ†é¡µæ§ä»¶UIï¼Œä¸æ”¹å˜æ˜¾ç¤º =================
    function updatePaginationControls() {
        const paginationWrapper = document.getElementById('paginationWrapper');
        const pagination = document.getElementById('pagination');
        const paginationInfo = document.getElementById('paginationInfo');

        if (!paginationWrapper || !pagination || !paginationInfo) return;
        
        if (!filteredItems || filteredItems.length === 0) {
            paginationWrapper.style.display = 'none';
            return;
        }

        const totalItems = filteredItems.length;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

        if (totalPages <= 1) {
            paginationWrapper.style.display = 'none';
            return;
        }

        paginationWrapper.style.display = 'flex';

        const start = (currentPage - 1) * ITEMS_PER_PAGE + 1;
        const end = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
        paginationInfo.textContent = `Showing ${start}-${end} of ${totalItems} items`;

        // ç”Ÿæˆåˆ†é¡µæŒ‰é’®
        pagination.innerHTML = '';

        // ä¸Šä¸€é¡µ
        const prevButton = document.createElement('li');
        prevButton.className = `fm-page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevButton.innerHTML = `<a class="fm-page-link" href="#" aria-label="Previous"><i class="fas fa-chevron-left"></i></a>`;
        prevButton.onclick = (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                showPage(currentPage - 1);
            }
        };
        pagination.appendChild(prevButton);

        // é¡µç æŒ‰é’®
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
            const firstPageButton = document.createElement('li');
            firstPageButton.className = 'fm-page-item';
            firstPageButton.innerHTML = `<a class="fm-page-link" href="#">1</a>`;
            firstPageButton.onclick = (e) => {
                e.preventDefault();
                showPage(1);
            };
            pagination.appendChild(firstPageButton);

            if (startPage > 2) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'fm-page-item disabled';
                ellipsis.innerHTML = `<span class="fm-page-link">...</span>`;
                pagination.appendChild(ellipsis);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('li');
            pageButton.className = `fm-page-item ${i === currentPage ? 'active' : ''}`;
            pageButton.innerHTML = `<a class="fm-page-link" href="#">${i}</a>`;
            pageButton.onclick = (e) => {
                e.preventDefault();
                showPage(i);
            };
            pagination.appendChild(pageButton);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'fm-page-item disabled';
                ellipsis.innerHTML = `<span class="fm-page-link">...</span>`;
                pagination.appendChild(ellipsis);
            }

            const lastPageButton = document.createElement('li');
            lastPageButton.className = 'fm-page-item';
            lastPageButton.innerHTML = `<a class="fm-page-link" href="#">${totalPages}</a>`;
            lastPageButton.onclick = (e) => {
                e.preventDefault();
                showPage(totalPages);
            };
            pagination.appendChild(lastPageButton);
        }

        // ä¸‹ä¸€é¡µ
        const nextButton = document.createElement('li');
        nextButton.className = `fm-page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextButton.innerHTML = `<a class="fm-page-link" href="#" aria-label="Next"><i class="fas fa-chevron-right"></i></a>`;
        nextButton.onclick = (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
            }
        };
        pagination.appendChild(nextButton);
    }

    // ================= åˆå§‹åŒ–åˆ†é¡µå’Œæœç´¢ï¼ˆä»…ä¾›ç½‘æ ¼è§†å›¾ä½¿ç”¨ï¼‰=================
    window.initializePaginationAndSearch = function() {
        // ğŸ”¥ å¦‚æœæ˜¯åˆ—è¡¨è§†å›¾ï¼Œä¸æ‰§è¡Œç½‘æ ¼è§†å›¾çš„åˆ†é¡µé€»è¾‘
        if (isCurrentViewList()) {
            return;
        }

        refreshItemsData();

        if (allItems.length === 0) {
            const paginationWrapper = document.getElementById('paginationWrapper');
            if (paginationWrapper) paginationWrapper.style.display = 'none';
            return;
        }

        const isListView = isCurrentViewList();

        console.log(`åˆå§‹åŒ–åˆ†é¡µ: ${isListView ? 'åˆ—è¡¨è§†å›¾' : 'ç½‘æ ¼è§†å›¾'}, å…± ${allItems.length} ä¸ªé¡¹ç›®`);

        // é‡ç½®è¿‡æ»¤åçš„é¡¹ç›®
        if (filteredItems.length === 0) {
            filteredItems = [...allItems];
        }

        // æ ¹æ®é¡¹ç›®æ•°é‡å†³å®šæ˜¯å¦æ˜¾ç¤ºåˆ†é¡µ
        if (allItems.length > ITEMS_PER_PAGE) {
            const paginationWrapper = document.getElementById('paginationWrapper');
            if (paginationWrapper) paginationWrapper.style.display = 'flex';

            // åˆå§‹åŒ–é¡µç 
            if (!currentPage || currentPage < 1) currentPage = 1;
            const maxPage = Math.ceil(allItems.length / ITEMS_PER_PAGE);
            if (currentPage > maxPage) currentPage = 1;

            // æ˜¾ç¤ºå½“å‰é¡µ
            showPage(currentPage);
        } else {
            const paginationWrapper = document.getElementById('paginationWrapper');
            if (paginationWrapper) paginationWrapper.style.display = 'none';

            // æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®
            allItems.forEach(item => {
                if (item.element) {
                    if (isListView) {
                        item.element.classList.remove('fm-hidden');
                    } else {
                        item.element.style.display = '';
                    }
                }
            });
        }

        // ç»‘å®šæœç´¢äº‹ä»¶
        bindSearchEvents();
    };

    // ================= æœç´¢åŠŸèƒ½ï¼ˆä»…ä¾›ç½‘æ ¼è§†å›¾ä½¿ç”¨ï¼‰=================
    window.handleSearch = function(event) {
        // ğŸ”¥ å¦‚æœæ˜¯åˆ—è¡¨è§†å›¾ï¼Œä¸æ‰§è¡Œç½‘æ ¼è§†å›¾çš„æœç´¢é€»è¾‘
        if (isCurrentViewList()) {
            return;
        }

        if (event.key === 'Enter' || event.type === 'keyup' || event.type === 'input') {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            const searchTerm = searchInput.value.trim().toLowerCase();
            currentSearchTerm = searchTerm;

            if (searchTerm === '') {
                clearSearch();
                return;
            }

            performSearch(searchTerm);
        }
    };

    function performSearch(searchTerm) {
        console.log('ğŸ” æ‰§è¡Œç½‘æ ¼è§†å›¾æœç´¢:', searchTerm);
        
        if (!searchTerm) {
            clearSearch();
            return;
        }

        refreshItemsData();

        // ğŸ”¥ ä¿®å¤ï¼šåªè¿‡æ»¤ï¼Œä¸ç›´æ¥æ“ä½œæ˜¾ç¤º
        filteredItems = allItems.filter(item => {
            const itemName = item.name.toLowerCase();
            const shouldShow = itemName.includes(searchTerm);
            item.isVisible = shouldShow;
            return shouldShow;
        });

        console.log(`æ‰¾åˆ° ${filteredItems.length} ä¸ªåŒ¹é…é¡¹`);

        // ğŸ”¥ ä¿®å¤ï¼šå…ˆéšè—æ‰€æœ‰é¡¹ç›®
        allItems.forEach(item => {
            if (item.element) {
                item.element.style.display = 'none';
            }
        });

        // å¦‚æœæ²¡æœ‰åŒ¹é…ç»“æœ
        if (filteredItems.length === 0) {
            console.log('æ²¡æœ‰åŒ¹é…ç»“æœï¼Œéšè—åˆ†é¡µ');
            const paginationWrapper = document.getElementById('paginationWrapper');
            if (paginationWrapper) paginationWrapper.style.display = 'none';
            
            // æ˜¾ç¤ºç©ºçŠ¶æ€æ¶ˆæ¯
            const emptyState = document.getElementById('emptySearchState');
            if (emptyState) emptyState.style.display = 'flex';
            
            showSearchResultsInfo(searchTerm, 0);
            return;
        }

        // éšè—ç©ºçŠ¶æ€
        const emptyState = document.getElementById('emptySearchState');
        if (emptyState) emptyState.style.display = 'none';

        // é«˜äº®æœç´¢ç»“æœ
        highlightSearchMatches(searchTerm);

        // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        currentPage = 1;

        // æ›´æ–°åˆ†é¡µï¼ˆè¿™ä¼šæ˜¾ç¤ºå½“å‰é¡µçš„é¡¹ç›®ï¼‰
        updatePagination();

        // å¦‚æœç»“æœä¸è¶…è¿‡ä¸€é¡µï¼Œæ˜¾ç¤ºæ‰€æœ‰åŒ¹é…é¡¹
        if (filteredItems.length <= ITEMS_PER_PAGE) {
            console.log('ç»“æœä¸è¶…è¿‡ä¸€é¡µï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡¹');
            filteredItems.forEach(item => {
                if (item.element) {
                    item.element.style.display = '';
                }
            });
        } else {
            // å¦åˆ™åªæ˜¾ç¤ºç¬¬ä¸€é¡µ
            showPage(1);
        }

        showSearchResultsInfo(searchTerm, filteredItems.length);
    }

    function highlightSearchMatches(searchTerm) {
        if (!searchTerm) return;

        // ç§»é™¤å·²æœ‰çš„é«˜äº®
        document.querySelectorAll('.fm-highlight').forEach(el => {
            const parent = el.parentNode;
            parent.replaceChild(document.createTextNode(el.textContent), el);
            parent.normalize();
        });

        // ä¸ºåŒ¹é…çš„é¡¹ç›®æ·»åŠ é«˜äº®
        filteredItems.forEach(item => {
            if (item.element) {
                const nameElement = item.element.querySelector('.fm-grid-item-name, .fm-list-name');
                if (nameElement) {
                    const originalText = nameElement.textContent || nameElement.innerText;
                    const highlightedText = originalText.replace(
                        new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi'),
                        '<span class="fm-highlight">$1</span>'
                    );
                    nameElement.innerHTML = highlightedText;
                }
            }
        });
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    window.clearSearch = function() {
        // ğŸ”¥ å¦‚æœæ˜¯åˆ—è¡¨è§†å›¾ï¼Œä¸æ‰§è¡Œç½‘æ ¼è§†å›¾çš„æ¸…é™¤æœç´¢é€»è¾‘
        if (isCurrentViewList()) {
            return;
        }

        console.log('ğŸ§¹ æ¸…é™¤ Grid View æœç´¢');

        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');
        const mobileSearchInput = document.getElementById('mobileSearchInput');
        const mobileSearchClear = document.getElementById('mobileSearchClear');

        if (searchInput) searchInput.value = '';
        if (searchClear) searchClear.style.display = 'none';
        if (mobileSearchInput) mobileSearchInput.value = '';
        if (mobileSearchClear) mobileSearchClear.style.display = 'none';

        currentSearchTerm = '';

        // ğŸ”¥ éšè—ç©ºçŠ¶æ€æ¶ˆæ¯
        const emptyState = document.getElementById('emptySearchState');
        if (emptyState) {
            emptyState.style.display = 'none';
            console.log('âœ“ éšè—ç©ºçŠ¶æ€');
        }

        refreshItemsData();

        const isListView = isCurrentViewList();

        // æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®
        allItems.forEach(item => {
            if (item.element) {
                if (isListView) {
                    item.element.classList.remove('fm-hidden');
                } else {
                    item.element.style.display = '';
                }
                item.isVisible = true;
            }
        });

        // ç§»é™¤é«˜äº®
        document.querySelectorAll('.fm-highlight').forEach(el => {
            const parent = el.parentNode;
            parent.replaceChild(document.createTextNode(el.textContent), el);
            parent.normalize();
        });

        filteredItems = [...allItems];
        currentPage = 1;

        window.initializePaginationAndSearch();

        document.getElementById('searchResultsInfo')?.remove();
        
        console.log('âœ… Grid View æœç´¢å·²æ¸…é™¤');
    };

    function showSearchResultsInfo(searchTerm, resultCount) {
        const oldInfo = document.getElementById('searchResultsInfo');
        if (oldInfo) oldInfo.remove();

        if (!searchTerm) return;

        const infoElement = document.createElement('div');
        infoElement.id = 'searchResultsInfo';
        infoElement.className = 'fm-search-results-info';
        infoElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-gray); border-radius: 6px; margin: 10px 0;">
                <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                <span style="color: var(--text-primary); font-weight: 500;">Search results for "${searchTerm}"</span>
                <span style="color: var(--text-secondary); margin-left: auto;">${resultCount} items found</span>
                <button onclick="clearSearch()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    Clear <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        const filesContainer = document.querySelector('.fm-files-container');
        if (filesContainer) {
            filesContainer.parentNode.insertBefore(infoElement, filesContainer);
        }
    }

    // ================= ç»‘å®šæœç´¢äº‹ä»¶ï¼ˆä»…ä¾›ç½‘æ ¼è§†å›¾ä½¿ç”¨ï¼‰=================
    function bindSearchEvents() {
        // ğŸ”¥ å¦‚æœæ˜¯åˆ—è¡¨è§†å›¾ï¼Œä¸ç»‘å®šç½‘æ ¼è§†å›¾çš„æœç´¢äº‹ä»¶
        if (isCurrentViewList()) {
            return;
        }

        console.log('ğŸ”§ ç»‘å®š Grid View æœç´¢äº‹ä»¶');
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');

        if (searchInput) {
            // ğŸ”¥ ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†ï¼‰
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // ç§»é™¤ onkeyup å±æ€§ï¼Œä½¿ç”¨ addEventListener
            newSearchInput.removeAttribute('onkeyup');
            newSearchInput.id = 'searchInput';
            
            // ç»‘å®š input äº‹ä»¶
            newSearchInput.addEventListener('input', function() {
                console.log('ğŸ” Grid View Search input changed:', this.value);
                
                const searchClear = document.getElementById('searchClear');
                if (searchClear) {
                    searchClear.style.display = this.value ? 'block' : 'none';
                }

                if (this.value.trim() === '') {
                    clearSearch();
                } else {
                    const searchTerm = this.value.trim().toLowerCase();
                    if (searchTerm !== currentSearchTerm) {
                        performSearch(searchTerm);
                    }
                }
            });
            
            // ç»‘å®š keyup äº‹ä»¶ï¼ˆå¤„ç† Enter é”®ï¼‰
            newSearchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim().toLowerCase();
                    if (searchTerm) {
                        performSearch(searchTerm);
                    } else {
                        clearSearch();
                    }
                }
            });

            if (searchClear) {
                searchClear.style.display = newSearchInput.value ? 'block' : 'none';
                searchClear.onclick = clearSearch;
            }
            
            console.log('âœ… Grid View æœç´¢äº‹ä»¶ç»‘å®šå®Œæˆ');
        }
    }

    // ================= ç§»åŠ¨ç«¯æœç´¢å‡½æ•° =================
    function setupMobileSearchSync() {
        const mobileInput = document.getElementById('mobileSearchInput');
        const desktopInput = document.getElementById('searchInput');

        if (mobileInput && desktopInput) {
            mobileInput.removeEventListener('input', handleMobileInput);
            mobileInput.addEventListener('input', handleMobileInput);
        }

        const mobileClear = document.getElementById('mobileSearchClear');
        if (mobileClear) {
            mobileClear.onclick = clearMobileSearch;
        }
    }

    function handleMobileInput() {
        const desktopInput = document.getElementById('searchInput');
        if (desktopInput) {
            desktopInput.value = this.value;
        }

        const mobileClear = document.getElementById('mobileSearchClear');
        if (mobileClear) {
            mobileClear.style.display = this.value ? 'block' : 'none';
        }

        if (this.value.trim() === '') {
            if (isCurrentViewList()) {
                clearListViewSearch();
            } else {
                clearSearch();
            }
        } else {
            const searchTerm = this.value.trim().toLowerCase();
            if (isCurrentViewList()) {
                performListViewSearch(searchTerm);
            } else {
                performSearch(searchTerm);
            }
        }
    }

    window.handleMobileSearch = function(event) {
        if (event.key === 'Enter' || event.type === 'keyup' || event.type === 'input') {
            const mobileInput = document.getElementById('mobileSearchInput');
            const desktopInput = document.getElementById('searchInput');

            if (mobileInput && desktopInput) {
                desktopInput.value = mobileInput.value;

                const mobileClear = document.getElementById('mobileSearchClear');
                if (mobileClear) {
                    mobileClear.style.display = mobileInput.value ? 'block' : 'none';
                }

                if (isCurrentViewList()) {
                    if (mobileInput.value.trim() === '') {
                        clearListViewSearch();
                    } else {
                        performListViewSearch(mobileInput.value.trim());
                    }
                } else {
                    handleSearch({ key: 'Enter', target: desktopInput });
                }
            }
        }
    };

    window.clearMobileSearch = function() {
        const mobileInput = document.getElementById('mobileSearchInput');
        const desktopInput = document.getElementById('searchInput');

        if (mobileInput) mobileInput.value = '';
        if (desktopInput) desktopInput.value = '';

        const mobileClear = document.getElementById('mobileSearchClear');
        if (mobileClear) mobileClear.style.display = 'none';

        if (isCurrentViewList()) {
            clearListViewSearch();
        } else {
            clearSearch();
        }
    };

    // ================= å…¨å±€Toastå‡½æ•° =================
    window.showToast = function(title, message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;

        const toast = document.createElement('div');
        toast.className = `fm-toast ${type}`;

        const icons = {
            'success': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'info': 'â„¹ï¸'
        };

        toast.innerHTML = `
            <div class="fm-toast-icon">${icons[type] || icons.info}</div>
            <div class="fm-toast-content">
                <div class="fm-toast-title">${title}</div>
                <div class="fm-toast-message">${message}</div>
            </div>
            <button class="fm-toast-close" onclick="this.parentElement.remove()">Ã—</button>
        `;

        toastContainer.appendChild(toast);

        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    };

    // ================= æ–‡ä»¶å¤¹æ¨¡æ€æ¡†å‡½æ•° =================
    window.showCreateFolderModal = function() {
        const modal = document.getElementById('createFolderModal');
        const input = document.getElementById('folderNameInput');

        if (modal) modal.classList.add('active');
        if (input) {
            input.value = '';
            setTimeout(() => input.focus(), 100);
        }
    };

    window.hideCreateFolderModal = function() {
        const modal = document.getElementById('createFolderModal');
        if (modal) modal.classList.remove('active');
    };

    // ================= å…¨å±€ç™»å‡ºå‡½æ•° =================
    window.showLogoutModal = function() {
        const modal = document.createElement('div');
        modal.className = 'fm-modal-overlay active';
        modal.id = 'logoutModal';

        modal.innerHTML = `
            <div class="fm-modal-box">
                <div class="fm-modal-icon-header warning">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </div>
                <div class="fm-modal-content">
                    <h3>Confirm Logout</h3>
                    <p>Are you sure you want to logout?</p>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">You will need to login again to access your files.</p>
                </div>
                <div class="fm-modal-actions">
                    <button class="fm-btn-text" onclick="hideLogoutModal()">Cancel</button>
                    <button class="fm-btn-danger" onclick="confirmLogout()">Logout</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    };

    window.hideLogoutModal = function() {
        const modal = document.getElementById('logoutModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    };

    window.confirmLogout = function() {
        localStorage.removeItem('spaceHSG_user');
        localStorage.removeItem('spaceHSG_viewMode');
        localStorage.removeItem('spaceHSG_currentPage');
        localStorage.removeItem('spaceHSG_searchTerm');
        localStorage.removeItem('spaceHSG_listView_page');
        localStorage.removeItem('spaceHSG_listView_search');
        window.location.href = '@Url.Action("Logout", "Account")';
    };

    // ================= æ‰¹é‡åˆ é™¤æ¨¡æ€æ¡† =================
    window.showBatchDeleteModal = function(count) {
        const modal = document.getElementById('batchDeleteModal');
        const countSpan = document.getElementById('batchDeleteCount');
        if (countSpan) countSpan.textContent = count;
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    };

    window.hideBatchDeleteModal = function() {
        const modal = document.getElementById('batchDeleteModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    };

    window.confirmBatchDelete = function() {
        if (typeof deleteSelectedItems === 'function') {
            deleteSelectedItems();
        }
        hideBatchDeleteModal();
    };

    // ================= å¯¼èˆªå‡½æ•° =================
    window.navigateToItem = function(url) {
        if (url) {
            window.location.href = url;
        }
    };

    window.navigateToItemByElement = function(element) {
        const listItem = element.closest('.fm-list-item');
        if (listItem) {
            const path = listItem.dataset.path;
            const type = listItem.dataset.type;

            if (path && type) {
                if (type === 'Folder') {
                    window.location.href = '@Url.Action("Index", "Home")?path=' + encodeURIComponent(path);
                } else {
                    window.location.href = '@Url.Action("Download", "Home")?path=' + encodeURIComponent(path);
                }
            }
        }
    };

        // ================= æ–°å¢ï¼šåˆ—è¡¨è§†å›¾ç©ºæœç´¢ç»“æœ =================
    function showListViewEmptyState(searchTerm) {
        console.log('ğŸ“­ æ˜¾ç¤ºList Viewç©ºçŠ¶æ€:', searchTerm);
        
        // ç›´æ¥ä½¿ç”¨HTMLä¸­å·²æœ‰çš„emptySearchStateå…ƒç´ 
        const emptyState = document.getElementById('emptySearchState');
        if (emptyState) {
            emptyState.style.display = 'flex';
            console.log('âœ… ç©ºçŠ¶æ€å·²æ˜¾ç¤ºï¼ˆä½¿ç”¨HTMLå…ƒç´ ï¼‰');
        } else {
            console.warn('Empty search state element not found');
        }
    }
</script>