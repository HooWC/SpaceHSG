@{
    ViewData["Title"] = "Files";
}

<!-- Toast Container -->
<div class="fm-toast-container" id="toastContainer"></div>

<!-- Drop Overlay -->
<div class="fm-drop-overlay" id="dropOverlay">
    <div class="fm-drop-content">
        <div class="fm-drop-icon">ğŸ“</div>
        <div class="fm-drop-text">Drop files or folders here</div>
        <div class="fm-drop-hint">Release to upload your files and folders with structure preserved</div>
    </div>
</div>

<div class="file-manager-container">
    <!-- Header -->
    <div class="fm-header">
        <a href="~/Home/index" class="logo-text-a">
            <h1 class="fm-title">
                <div class="fm-title-icon">â˜ï¸</div>
                SpaceHSG
            </h1>
        </a>
        <div class="fm-toolbar">
            <button id="uploadBtn" class="fm-btn fm-btn-primary" onclick="document.getElementById('fileInput').click()">
                <span class="fm-btn-icon">â¬†ï¸</span>
                Upload
            </button>
            <button id="newFolderBtn" class="fm-btn" onclick="showCreateFolderModal()">
                <span class="fm-btn-icon">â•</span>
                New Folder
            </button>
            <button class="fm-btn" onclick="refreshFileListWithoutReload()" title="Refresh without reloading page">
                <span class="fm-btn-icon">ğŸ”„</span>
                Refresh
            </button>
            <button class="fm-theme-toggle" id="themeToggle" onclick="toggleThemeNow()">
                <span id="themeIcon">ğŸŒ™</span>
            </button>
            <div class="fm-view-toggle">
                <button class="fm-view-btn active" id="viewGrid" onclick="switchView('grid')">
                    <span>âŠ</span>
                </button>
                <button class="fm-view-btn" id="viewList" onclick="switchView('list')">
                    <span>â˜°</span>
                </button>
            </div>

            <button id="logoutBtn" class="fm-btn fm-btn-logout">
                Logout â»
            </button>
        </div>
    </div>

    <!-- Breadcrumb Navigation -->
    @if (ViewBag.Breadcrumbs != null)
    {
        <div class="fm-breadcrumb">
            @foreach (var crumb in ViewBag.Breadcrumbs)
            {
                if (crumb.IsActive)
                {
                    <div class="fm-breadcrumb-item">
                        <span class="fm-breadcrumb-current">@crumb.Name</span>
                    </div>
                }
                else
                {
                    <div class="fm-breadcrumb-item">
                        <a href="@Url.Action("Index", new { path = crumb.Path })" class="fm-breadcrumb-link">
                            @crumb.Name
                        </a>
                        <span class="fm-breadcrumb-separator">â€º</span>
                    </div>
                }
            }
        </div>
    }

    <!-- Hidden File Input (supports both files and folders) -->
    <input type="file" id="fileInput" multiple style="display: none;" />

    <!-- Hidden Progress -->
    <div class="fm-progress" id="uploadProgress" style="position: fixed; top: 0; left: 0; right: 0; z-index: 9998;">
        <div class="fm-progress-bar" id="uploadProgressBar"></div>
    </div>

    <!-- Create Folder Modal -->
    <div class="fm-modal-overlay" id="createFolderModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Create New Folder</h3>
                <button class="fm-modal-close" onclick="hideCreateFolderModal()">Ã—</button>
            </div>
            <div class="fm-modal-body">
                <div class="fm-form-group">
                    <label class="fm-form-label" for="folderNameInput">Folder Name</label>
                    <input type="text" class="fm-form-input" id="folderNameInput" placeholder="Enter folder name" />
                </div>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideCreateFolderModal()">Cancel</button>
                <button class="fm-btn fm-btn-primary" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="fm-modal-overlay" id="batchDeleteModal" style="display: none;">
        <div class="fm-modal-box">
            <div class="fm-modal-icon-header danger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </div>
            <div class="fm-modal-content">
                <h3>Delete Selected Items</h3>
                <p>Are you sure you want to delete <strong id="batchDeleteCount">0</strong> selected item(s)?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">This action cannot be undone.</p>
            </div>
            <div class="fm-modal-actions">
                <button class="fm-btn-text" onclick="hideBatchDeleteModal()">Cancel</button>
                <button class="fm-btn-danger" onclick="confirmBatchDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <!-- <div class="fm-modal-overlay" id="deleteModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Confirm Delete</h3>
                <button class="fm-modal-close" onclick="hideDeleteModal()">Ã—</button>
            </div>
            <div class="fm-modal-body">
                <p>Are you sure you want to delete "<strong id="deleteItemName"></strong>"?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">This action cannot be undone.</p>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button class="fm-btn fm-btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div> -->

    <!-- Error Message -->
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @ViewBag.Error
        </div>
    }

    <!-- Files Container -->
    <div class="fm-files-container">
        <div class="fm-files-header">
            <!-- å·¦ä¾§ï¼šå…¨é€‰æŒ‰é’® + æ–‡ä»¶ç»Ÿè®¡ -->
            <div class="fm-header-left">
                <div class="fm-select-all-container fm-write-permission-only">
                    <button class="fm-select-all-btn" id="selectAllHeader" title="Select all items">
                        <span class="fm-select-all-icon"></span>
                        All
                    </button>
                </div>
                <div class="fm-files-count">
                    @{
                        // ä¿®å¤ï¼šå®‰å…¨å¤„ç†ViewBag.Itemsçš„ç±»å‹è½¬æ¢
                        var itemsList = ViewBag.Items as System.Collections.IEnumerable;
                        var folderCount = 0;
                        var fileCount = 0;

                        if (itemsList != null)
                        {
                            // ä½¿ç”¨åŠ¨æ€ç±»å‹è®¿é—®æˆ–å®‰å…¨çš„è½¬æ¢æ–¹å¼
                            foreach (dynamic item in itemsList)
                            {
                                if (item.Type == "Folder")
                                    folderCount++;
                                else
                                    fileCount++;
                            }
                        }
                    }
                    @folderCount folders, @fileCount files
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ‰¹é‡æ“ä½œæŒ‰é’® (é»˜è®¤éšè—) -->
            <div class="fm-batch-actions fm-write-permission-only" id="batchActions" style="display: none;">
                <div class="fm-selected-count" id="selectedCount">
                    <span id="selectedNumber">0</span> selected
                </div>
                <button class="fm-btn fm-btn-danger" id="batchDeleteBtn" title="Delete selected items">
                    <span class="fm-btn-icon">ğŸ—‘ï¸</span>
                    Delete Selected
                </button>
            </div>
        </div>

        @if (ViewBag.Items != null && ((System.Collections.ICollection)ViewBag.Items).Count > 0)
        {
            <!-- Grid View (Default) -->
            <div class="fm-grid-view" id="gridView">
                @foreach (dynamic item in ViewBag.Items)
                {
                    <div class="fm-grid-item" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type">

                        <div class="fm-grid-checkbox-container fm-write-permission-only" onclick="event.stopPropagation();">
                            <div class="fm-grid-checkbox"></div>
                        </div>

                        <div class="fm-grid-item-icon fm-icon-@(item.Type == "Folder" ? "folder" : ((string)item.Extension).TrimStart('.'))" onclick="navigateToItem('@(item.Type == "Folder" ?
                                                                                                                                                                      Url.Action("Index", new { path = item.Path }) :
                                                                                                                                                                      Url.Action("Download", new { path = item.Path }))')">
                            @if (item.Type == "Folder")
                            {
                                <text>ğŸ“</text>
                            }
                            else
                            {
                                @GetFileIcon(item.Extension)
                            }
                        </div>
                        <div class="fm-grid-item-name" title="@item.Name">@item.Name</div>
                        @if (item.Type == "File")
                        {
                            <div class="fm-grid-item-info">@FormatFileSize(item.Size)</div>
                        }
                        else
                        {
                            <div class="fm-grid-item-info">Folder</div>
                        }
                    </div>
                }
            </div>

            <!-- List View (Hidden by default) -->
            <div class="fm-list-view" id="listView" style="display: none;">
                <div class="fm-list-header">
                    <!-- å…¨é€‰å¤é€‰æ¡† -->
                    <div class="fm-list-checkbox-container fm-write-permission-only" id="listSelectAllContainer">
                        <div class="fm-list-checkbox" id="selectAllCheckbox"></div>
                    </div>

                    <div></div>
                    <div>Name</div>
                    <div>Type</div>
                    <div>Size</div>
                    <div>Modified</div>
                    <div>Actions</div>
                </div>
                @foreach (dynamic item in ViewBag.Items)
                {
                    <div class="fm-list-item" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type">
                        <div class="fm-list-checkbox-container fm-write-permission-only" onclick="event.stopPropagation();">
                            <div class="fm-list-checkbox"></div>
                        </div>
                        <div class="fm-list-icon fm-icon-@(item.Type == "Folder" ? "folder" : ((string)item.Extension).TrimStart('.'))"
                             onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <text>ğŸ“</text>
                            }
                            else
                            {
                                @GetFileIcon(item.Extension)
                            }
                        </div>
                        <div class="fm-list-name" title="@item.Name" onclick="navigateToItemByElement(this)">@item.Name</div>
                        <div class="fm-list-type" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <span class="fm-badge fm-badge-folder">Folder</span>
                            }
                            else
                            {
                                <span class="fm-badge fm-badge-file">@item.Extension</span>
                            }
                        </div>
                        <div class="fm-list-size" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "File")
                            {
                                @FormatFileSize(item.Size)
                            }
                            else
                            {
                                <text>â€”</text>
                            }
                        </div>
                        <div class="fm-list-date" onclick="navigateToItemByElement(this)">@(((DateTime)item.Modified).ToString("MMM dd, yyyy"))</div>
                        <div class="fm-list-actions" onclick="event.stopPropagation()">
                            @if (item.Type == "File")
                            {
                                <button class="fm-action-btn download-icon-btn" title="Download">
                                    <span class="fm-action-icon"><i class="fa-solid fa-download"></i></span>
                                </button>
                            }
                            else
                            {
                                <button class="fm-action-btn open-icon-btn" title="Open">
                                    <span class="fm-action-icon">ğŸ“‚</span>
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="fm-empty">
                <div class="fm-empty-icon">ğŸ“‚</div>
                <div class="fm-empty-text">This folder is empty</div>
                <div class="fm-empty-hint">Drag files here or click Upload to add files</div>
            </div>
        }
    </div>
</div>

@functions {
    string GetFileIcon(string extension)
    {
        return extension?.ToLower() switch
        {
            ".doc" or ".docx" => "ğŸ“„",
            ".xls" or ".xlsx" => "ğŸ“Š",
            ".ppt" or ".pptx" => "ğŸ“½ï¸",
            ".pdf" => "ğŸ“•",
            ".txt" => "ğŸ“",
            ".zip" or ".rar" or ".7z" => "ğŸ“¦",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" => "ğŸ–¼ï¸",
            ".mp4" or ".avi" or ".mov" or ".wmv" => "ğŸ¬",
            ".mp3" or ".wav" or ".flac" => "ğŸµ",
            ".exe" => "âš™ï¸",
            ".html" or ".htm" => "ğŸŒ",
            ".css" => "ğŸ¨",
            ".js" => "ğŸ“œ",
            ".json" => "ğŸ“‹",
            ".xml" => "ğŸ“‹",
            ".cs" => "ğŸ’»",
            ".py" => "ğŸ",
            ".java" => "â˜•",
            _ => "ğŸ“„"
        };
    }

    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

<!-- åˆå§‹åŒ–è„šæœ¬ -->
<script>
    // é¡µé¢åŠ è½½ååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // ========== è®¾ç½®å…¨å±€ç”¨æˆ·ä¿¡æ¯ ==========
        window.userDepartment = '@(ViewBag.UserDepartment ?? "Unknown")';
        window.userDisplayName = '@(ViewBag.UserDisplayName ?? "")';
        window.userRole = '@(ViewBag.UserRole ?? "User")';

        // è®¾ç½®å…¨å±€å˜é‡
        const relativePath = '@(ViewBag.RelativePath ?? "")';

        if (typeof initializeFileManager === 'function') {
            initializeFileManager(relativePath, '@Url.Action("Upload", "Home")');
        } else {
            showToast('Error', 'InitializeFileManager function not found!', 'error');
        }

        // ========== æ ¹æ®æƒé™æ˜¾ç¤º/éšè—æŒ‰é’® ==========
        setTimeout(() => {
            checkAndUpdateButtonsVisibility();
        }, 100);

        // è®¾ç½®ç™»å‡ºæŒ‰é’®äº‹ä»¶ - ä½¿ç”¨å†…è”onclickè€Œä¸æ˜¯addEventListener
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            // ç›´æ¥è®¾ç½®onclickå±æ€§æ¥é¿å…ä½œç”¨åŸŸé—®é¢˜
            logoutBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                showLogoutModal();
            };
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
        @if (ViewBag.Error != null)
        {
                <text>
                    setTimeout(() => {
                        showToast('Error', '@Html.Raw(ViewBag.Error)', 'error');
                    }, 1000);
                </text>
        }

        // ä¸ºåˆ—è¡¨è§†å›¾å¤´éƒ¨çš„å…¨é€‰å¤é€‰æ¡†ç»‘å®šäº‹ä»¶
        const listSelectAllContainer = document.getElementById('listSelectAllContainer');
        if (listSelectAllContainer) {
            listSelectAllContainer.onclick = function(e) {
                e.stopPropagation();
                toggleSelectAll();
            };
        }

        // é‡æ–°ç»‘å®šç½‘æ ¼è§†å›¾äº‹ä»¶
        setTimeout(() => {
            reattachGridEvents();
        }, 200);
    });

    // ========== å…¨å±€ç™»å‡ºå‡½æ•° ==========
    window.showLogoutModal = function() {
        const modal = document.createElement('div');
        modal.className = 'fm-modal-overlay active';
        modal.id = 'logoutModal';

        modal.innerHTML = `
            <div class="fm-modal-box">
                <div class="fm-modal-icon-header warning">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                </div>
                <div class="fm-modal-content">
                    <h3>Confirm Logout</h3>
                    <p>Are you sure you want to logout?</p>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">You will need to login again to access your files.</p>
                </div>
                <div class="fm-modal-actions">
                    <button class="fm-btn-text" onclick="hideLogoutModal()">Cancel</button>
                    <button class="fm-btn-danger" onclick="confirmLogout()">Logout</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    };

    window.hideLogoutModal = function() {
        const modal = document.getElementById('logoutModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    };

    window.confirmLogout = function() {
        // Clear localStorage
        localStorage.removeItem('spaceHSG_user');
        window.location.href = '@Url.Action("Logout", "Account")';
    };

    // å…¨å±€è¾…åŠ©å‡½æ•°
    function showToast(title, message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;

        const toast = document.createElement('div');
        toast.className = `fm-toast fm-toast-${type}`;

        const icons = {
            'success': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'info': 'â„¹ï¸'
        };

        toast.innerHTML = `
            <div class="fm-toast-icon">${icons[type] || icons.info}</div>
            <div class="fm-toast-content">
                <div class="fm-toast-title">${title}</div>
                <div class="fm-toast-message">${message}</div>
            </div>
            <button class="fm-toast-close" onclick="this.parentElement.remove()">Ã—</button>
        `;

        toastContainer.appendChild(toast);

        // è‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    // æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸ
    window.showToast = showToast;

    // è¦†ç›–åŸæ¥çš„ showCreateFolderModal å‡½æ•°
    window.showCreateFolderModal = function() {
        const modal = document.getElementById('createFolderModal');
        const input = document.getElementById('folderNameInput');

        if (modal) modal.classList.add('active');
        if (input) {
            input.value = '';
            input.focus();
        }
    };
</script>