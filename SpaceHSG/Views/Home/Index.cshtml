@{
    ViewData["Title"] = "Files";
}

<!-- Toast Container -->
<div class="fm-toast-container" id="toastContainer"></div>

<!-- Drop Overlay -->
<div class="fm-drop-overlay" id="dropOverlay">
    <div class="fm-drop-content">
        @* <div class="fm-drop-icon">üìÅ</div> *@
        <div class="fm-drop-icon"><i class="fas fa-folder-open"></i></div>
        <div class="fm-drop-text">Drop files or folders here</div>
        <div class="fm-drop-hint">Release to upload your files and folders with structure preserved</div>
    </div>
</div>

<div class="file-manager-container">
    <!-- Header -->
    <div class="fm-header">
        <a href="@Url.Content("~/Home/index")" class="logo-text-a">
            <h1 class="fm-title">
                <img src="@Url.Content("~/Logo/logo.png")" alt="Logo" class="fm-title-icon"
                     style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px;" />SpaceHSG
            </h1>
        </a>
        <div class="fm-toolbar">
            <div class="fm-toolbar-left">
                <!-- Ê°åÈù¢Á´ØÊêúÁ¥¢Ê†è - Âè™Âú®ÈùûÊ†πÁõÆÂΩïÊòæÁ§∫ -->
                @if (ViewBag.RelativePath != null && !string.IsNullOrEmpty(ViewBag.RelativePath))
                {
                    <div class="fm-toolbar-search desktop-only">
                        <div class="fm-search-container">
                            <i class="fas fa-search fm-search-icon"></i>
                            <input type="text"
                                   class="fm-search-input"
                                   id="searchInput"
                                   placeholder="Search files and folders..."
                                   onkeyup="handleSearch(event)">
                            <button class="fm-search-clear" id="searchClear" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                }

                <button id="uploadBtn" class="fm-btn fm-btn-primary" onclick="typeof triggerUpload === 'function' ? triggerUpload() : document.getElementById('fileInput') && document.getElementById('fileInput').click()">
                    <span class="fm-btn-icon"><i class="fas fa-upload"></i></span>
                    Upload
                </button>
                <button id="newFolderBtn" class="fm-btn" onclick="showCreateFolderModal()">
                    <span class="fm-btn-icon"><i class="fas fa-folder-plus"></i></span>
                    New Folder
                </button>
                <button class="fm-btn" onclick="refreshFileListWithoutReload()" title="Refresh without reloading page">
                    <span class="fm-btn-icon"><i class="fas fa-rotate-right"></i></span>
                    Refresh
                </button>
                <button class="fm-theme-toggle" id="themeToggle" onclick="toggleThemeNow()">
                    <span id="themeIcon"><i class="fas fa-moon"></i></span>
                </button>
            </div>
            <div class="fm-view-toggle">
                <button class="fm-view-btn active" id="viewGrid" onclick="switchView('grid')">
                    <span><i class="fas fa-th-large"></i></span>
                </button>
                <button class="fm-view-btn" id="viewList" onclick="switchView('list')">
                    <span><i class="fas fa-list"></i></span>
                </button>
            </div>

            <div class="fm-toolbar-right-logout">
                <button id="logoutBtn" class="fm-btn fm-btn-logout">
                    Logout<i class="fas fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ÁßªÂä®Á´ØÊêúÁ¥¢Ê†è - Âè™Âú®ÈùûÊ†πÁõÆÂΩïÊòæÁ§∫ -->
    @if (ViewBag.RelativePath != null && !string.IsNullOrEmpty(ViewBag.RelativePath))
    {
        <div class="fm-toolbar-search mobile-only">
            <div class="fm-search-container">
                <i class="fas fa-search fm-search-icon"></i>
                <input type="text"
                       class="fm-search-input"
                       id="mobileSearchInput"
                       placeholder="Search files and folders...">
                <button class="fm-search-clear" id="mobileSearchClear" onclick="clearMobileSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    }

    <!-- Breadcrumb Navigation -->
    @if (ViewBag.Breadcrumbs != null)
    {
        <div class="fm-breadcrumb">
            @foreach (var crumb in ViewBag.Breadcrumbs)
            {
                if (crumb.IsActive)
                {
                    <div class="fm-breadcrumb-item">
                        <span class="fm-breadcrumb-current">@crumb.Name</span>
                    </div>
                }
                else
                {
                    <div class="fm-breadcrumb-item">
                        <a href="@Url.Action("Index", new { path = crumb.Path })" class="fm-breadcrumb-link">
                            @crumb.Name
                        </a>
                        <span class="fm-breadcrumb-separator">‚Ä∫</span>
                    </div>
                }
            }
        </div>
    }

    <!-- Hidden File Input (supports both files and folders) -->
    <input type="file" id="fileInput" multiple style="display: none;" />

    <!-- Hidden Progress -->
    <div class="fm-progress" id="uploadProgress" style="position: fixed; top: 0; left: 0; right: 0; z-index: 9998;">
        <div class="fm-progress-bar" id="uploadProgressBar"></div>
    </div>

    <!-- Create Folder Modal -->
    <div class="fm-modal-overlay" id="createFolderModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Create New Folder</h3>
                <button class="fm-modal-close" onclick="hideCreateFolderModal()">√ó</button>
            </div>
            <div class="fm-modal-body">
                <div class="fm-form-group">
                    <label class="fm-form-label" for="folderNameInput">Folder Name</label>
                    <input type="text" class="fm-form-input" id="folderNameInput" placeholder="Enter folder name" />
                </div>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideCreateFolderModal()">Cancel</button>
                <button class="fm-btn fm-btn-primary" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- ÊâπÈáèÂà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
    <div class="fm-modal-overlay" id="batchDeleteModal" style="display: none;">
        <div class="fm-modal-box">
            <div class="fm-modal-icon-header danger">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </div>
            <div class="fm-modal-content">
                <h3>Delete Selected Items</h3>
                <p>Are you sure you want to delete <strong id="batchDeleteCount">0</strong> selected item(s)?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">This action cannot be undone.</p>
            </div>
            <div class="fm-modal-actions">
                <button class="fm-btn-text" onclick="hideBatchDeleteModal()">Cancel</button>
                <button class="fm-btn-danger" onclick="confirmBatchDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <!-- <div class="fm-modal-overlay" id="deleteModal">
        <div class="fm-modal">
            <div class="fm-modal-header">
                <h3 class="fm-modal-title">Confirm Delete</h3>
                <button class="fm-modal-close" onclick="hideDeleteModal()">√ó</button>
            </div>
            <div class="fm-modal-body">
                <p>Are you sure you want to delete "<strong id="deleteItemName"></strong>"?</p>
                <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">This action cannot be undone.</p>
            </div>
            <div class="fm-modal-footer">
                <button class="fm-btn fm-btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button class="fm-btn fm-btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div> -->
    <!-- Error Message -->
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @ViewBag.Error
        </div>
    }

    <!-- Files Container -->
    <div class="fm-files-container">
        <div class="fm-files-header">
            <!-- Â∑¶‰æßÔºöÂÖ®ÈÄâÊåâÈíÆ + Êñá‰ª∂ÁªüËÆ° -->
            <div class="fm-header-left">
                <div class="fm-select-all-container fm-write-permission-only">
                    <button class="fm-select-all-btn" id="selectAllHeader" title="Select all items">
                        <span class="fm-select-all-icon"></span>
                        All
                    </button>
                </div>
                <div class="fm-files-count">
                    @{
                        // ‰øÆÂ§çÔºöÂÆâÂÖ®Â§ÑÁêÜViewBag.ItemsÁöÑÁ±ªÂûãËΩ¨Êç¢
                        var itemsList = ViewBag.Items as System.Collections.IEnumerable;
                        var folderCount = 0;
                        var fileCount = 0;

                        if (itemsList != null)
                        {
                            // ‰ΩøÁî®Âä®ÊÄÅÁ±ªÂûãËÆøÈóÆÊàñÂÆâÂÖ®ÁöÑËΩ¨Êç¢ÊñπÂºè
                            foreach (dynamic item in itemsList)
                            {
                                if (item.Type == "Folder")
                                    folderCount++;
                                else
                                    fileCount++;
                            }
                        }
                    }
                    @folderCount folders, @fileCount files
                </div>
            </div>

            <!-- Âè≥‰æßÔºöÊâπÈáèÊìç‰ΩúÊåâÈíÆ (ÈªòËÆ§ÈöêËóè) -->
            <div class="fm-batch-actions fm-write-permission-only" id="batchActions" style="display: none;">
                <div class="fm-selected-count" id="selectedCount">
                    <span id="selectedNumber">0</span> selected
                </div>
                <button class="fm-btn fm-btn-danger" id="batchDeleteBtn" title="Delete selected items">
                    @*<span class="fm-btn-icon">üóëÔ∏è</span>*@
                    <span class="fm-btn-icon"><i class="fas fa-trash"></i></span>
                    Delete Selected
                </button>
            </div>
        </div>

        @if (ViewBag.Items != null && ((System.Collections.ICollection)ViewBag.Items).Count > 0)
        {
            <!-- Grid View (Default) -->
            <div class="fm-grid-view" id="gridView">
                @foreach (dynamic item in ViewBag.Items)
                {
                    <div class="fm-grid-item" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type" onclick="navigateToItem('@(item.Type == "Folder" ?
                                                                                                                                                                                                                                                                                                                                                                                                        Url.Action("Index", new { path = item.Path }) :
                                                                                                                                                                                                                                                                                                                                                                                                        Url.Action("Download", new { path = item.Path }))')">

                        <div class="fm-grid-checkbox-container fm-write-permission-only" onclick="event.stopPropagation();">
                            <div class="fm-grid-checkbox"></div>
                        </div>

                        <div class="fm-grid-item-icon fm-icon-@(item.Type == "Folder" ? "folder" : ((string)item.Extension).TrimStart('.'))">
                            @if (item.Type == "Folder")
                            {
                                // <text>üìÅ</text>
                                <text><i class="fas fa-folder"></i></text>
                            }
                            else
                            {
                                @Html.Raw(GetFileIcon(item.Extension))
                            }
                        </div>
                        <div class="fm-grid-item-name" title="@item.Name">@item.Name</div>
                        @if (item.Type == "File")
                        {
                            <div class="fm-grid-item-info">@FormatFileSize(item.Size)</div>
                        }
                        else
                        {
                            <div class="fm-grid-item-info">Folder</div>
                        }
                    </div>
                }
            </div>

            <!-- List View (Hidden by default) -->
            <div class="fm-list-view" id="listView" style="display: none;">
                <div class="fm-list-header">
                    <!-- ÂÖ®ÈÄâÂ§çÈÄâÊ°Ü -->
                    <div class="fm-list-checkbox-container fm-write-permission-only" id="listSelectAllContainer">
                    </div>
                    <div></div>
                    <div>Name</div>
                    <div>Type</div>
                    <div>Size</div>
                    <div>Modified</div>
                    <div>Actions</div>
                </div>
                @foreach (dynamic item in ViewBag.Items)
                {
                    <!-- ‚úÖ ÂîØ‰∏Ä‰øÆÊîπÔºöÊ∑ªÂä† fm-hidden Á±ªÔºåÈªòËÆ§ÈöêËóèÊâÄÊúâÈ°πÔºåÂàÜÈ°µ‰ºöÊòæÁ§∫ÂΩìÂâçÈ°µ -->
                    <div class="fm-list-item fm-hidden" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type">
                        <div class="fm-list-checkbox-container fm-write-permission-only" onclick="event.stopPropagation();">
                            <div class="fm-list-checkbox"></div>
                        </div>
                        <div class="fm-list-icon fm-icon-@(item.Type == "Folder" ? "folder" : ((string)item.Extension).TrimStart('.'))"
                             onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <text><i class="fas fa-folder"></i></text>
                            }
                            else
                            {
                                @Html.Raw(GetFileIcon(item.Extension))
                            }
                        </div>
                        <div class="fm-list-name" title="@item.Name" onclick="navigateToItemByElement(this)">@item.Name</div>
                        <div class="fm-list-type" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "Folder")
                            {
                                <span class="fm-badge fm-badge-folder">Folder</span>
                            }
                            else
                            {
                                <span class="fm-badge fm-badge-file">@item.Extension</span>
                            }
                        </div>
                        <div class="fm-list-size" onclick="navigateToItemByElement(this)">
                            @if (item.Type == "File")
                            {
                                @FormatFileSize(item.Size)
                            }
                            else
                            {
                                <text>‚Äî</text>
                            }
                        </div>
                        <div class="fm-list-date" onclick="navigateToItemByElement(this)">@(((DateTime)item.Modified).ToString("MMM dd, yyyy"))</div>
                        <div class="fm-list-actions" onclick="event.stopPropagation()">
                            @if (item.Type == "File")
                            {
                                <button class="fm-action-btn download-icon-btn" title="Download">
                                    <span class="fm-action-icon"><i class="fa-solid fa-download"></i></span>
                                </button>
                            }
                            else
                            {
                                <button class="fm-action-btn open-icon-btn" title="Open">
                                    <span class="fm-action-icon"><i class="fas fa-folder-open"></i></span>
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- ÂàÜÈ°µÂÆπÂô®ÔºàÊîæÂú®Êñá‰ª∂ÂàóË°®‰πãÂêéÔºâ -->
            <div class="fm-pagination-wrapper" id="paginationWrapper" style="display: none;">
                <div class="fm-pagination-info" id="paginationInfo">
                    Showing 1-10 of 50 items
                </div>
                <ul class="fm-pagination" id="pagination">
                    <!-- ÂàÜÈ°µÊåâÈíÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </ul>
            </div>

            <!-- ÊêúÁ¥¢ÁªìÊûú‰∏∫Á©∫ÁöÑÁä∂ÊÄÅ -->
            <div class="fm-empty-search" id="emptySearchState" style="display: none;">
                <div class="fm-empty-search-content">
                    <div class="fm-empty-search-icon">
                        <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="45" cy="45" r="30" stroke="currentColor" stroke-width="4" fill="none" opacity="0.3"/>
                            <line x1="67" y1="67" x2="85" y2="85" stroke="currentColor" stroke-width="4" stroke-linecap="round" opacity="0.3"/>
                            <path d="M45 35 L45 45 M35 45 L55 45" stroke="currentColor" stroke-width="3" stroke-linecap="round" opacity="0.5"/>
                        </svg>
                    </div>
                    <div class="fm-empty-search-text">No matching files or folders</div>
                    <div class="fm-empty-search-hint">Try adjusting your search terms or filters</div>
                    @*<button class="fm-btn fm-btn-secondary fm-clear-search-btn" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear Search
                    </button>*@
                </div>
            </div>
        }
        else
        {
            <div class="fm-empty">
                @*<div class="fm-empty-icon">üìÇ</div>*@
                <div class="fm-empty-icon"><i class="fas fa-folder-open"></i></div>
                <div class="fm-empty-text">This folder is empty</div>
                <div class="fm-empty-hint">Drag files here or click Upload to add files</div>
            </div>
        }
    </div>
</div>

@functions {
    string GetFileIcon(string extension)
    {
        return extension?.ToLower() switch
        {
            ".doc" or ".docx" => "<i class='fas fa-file-word'></i>",
            ".xls" or ".xlsx" => "<i class='fas fa-file-excel'></i>",
            ".ppt" or ".pptx" => "<i class='fas fa-file-powerpoint'></i>",
            ".pdf" => "<i class='fas fa-file-pdf'></i>",
            ".txt" => "<i class='fas fa-file-alt'></i>",
            ".zip" or ".rar" or ".7z" => "<i class='fas fa-file-archive'></i>",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" => "<i class='fas fa-file-image'></i>",
            ".mp4" or ".avi" or ".mov" or ".wmv" => "<i class='fas fa-file-video'></i>",
            ".mp3" or ".wav" or ".flac" => "<i class='fas fa-file-audio'></i>",
            ".exe" => "<i class='fas fa-cog'></i>",
            ".html" or ".htm" => "<i class='fab fa-html5'></i>",
            ".css" => "<i class='fab fa-css3-alt'></i>",
            ".js" => "<i class='fab fa-js'></i>",
            ".json" => "<i class='fas fa-code'></i>",
            ".xml" => "<i class='fas fa-code'></i>",
            ".cs" => "<i class='fas fa-code'></i>",
            ".py" => "<i class='fab fa-python'></i>",
            ".java" => "<i class='fab fa-java'></i>",
            _ => "<i class='fas fa-file'></i>"
        };
    }

    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

<script>
window.SpaceHSGPageConfig = {
    userDepartment: '@(ViewBag.UserDepartment ?? "Unknown")',
    userDisplayName: '@(ViewBag.UserDisplayName ?? "")',
    userRole: '@(ViewBag.UserRole ?? "User")',
    relativePath: '@(ViewBag.RelativePath ?? "")',
    uploadActionUrl: '@(Url.Content("~/Home/Upload"))',
    indexUrl: '@(Url.Action("Index", "Home"))',
    downloadUrl: '@(Url.Action("Download", "Home"))',
    logoutUrl: '@(Url.Action("Logout", "Account"))',
    errorMessage: @(ViewBag.Error != null ? Html.Raw("\"" + ViewBag.Error.ToString().Replace("\\", "\\\\").Replace("\"", "\\\"").Replace("\r", "").Replace("\n", " ").Replace("</script>", "") + "\"") : Html.Raw("null"))
};
</script>
<script src="~/js/Home/index.js" asp-append-version="true"></script>