@model IEnumerable<dynamic>

@{
    var items = Model;
    var currentPath = ViewBag.CurrentPath as string ?? "";
    var isRoot = ViewBag.IsRoot as bool? ?? true;
}

@functions {
    string GetFileIcon(string extension)
    {
        return extension?.ToLower() switch
        {
            ".doc" or ".docx" => "📄",
            ".xls" or ".xlsx" => "📊",
            ".ppt" or ".pptx" => "📽️",
            ".pdf" => "📕",
            ".txt" => "📝",
            ".zip" or ".rar" or ".7z" => "📦",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" => "🖼️",
            ".mp4" or ".avi" or ".mov" or ".wmv" => "🎬",
            ".mp3" or ".wav" or ".flac" => "🎵",
            ".exe" => "⚙️",
            ".html" or ".htm" => "🌐",
            ".css" => "🎨",
            ".js" => "📜",
            ".json" => "📋",
            ".xml" => "📋",
            ".cs" => "💻",
            ".py" => "🐍",
            ".java" => "☕",
            _ => "📄"
        };
    }

    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    string EscapeForJs(string text)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return text.Replace("'", "\\'").Replace("\"", "\\\"").Replace("\r", "").Replace("\n", "");
    }
}

@if (!items.Any())
{
    <div class="fm-empty">
        <div class="fm-empty-icon">📂</div>
        <div class="fm-empty-text">This folder is empty</div>
        <div class="fm-empty-hint">Drag files here or click Upload to add files</div>
    </div>
}
else
{
    <!-- Grid View (Default) -->
    <div class="fm-grid-view" id="gridView">
        @foreach (var item in items)
        {
            <div class="fm-grid-item" data-path="@item.Path"
                 onclick="navigateToItem('@(item.Type == "Folder" ?
                                                             Url.Action("Index", "Home", new { path = item.Path }) :
                                                             Url.Action("Download", "Home", new { path = item.Path }))')">
                <button class="fm-delete-btn" onclick="event.stopPropagation(); showDeleteModal('@EscapeForJs(item.Name)', '@EscapeForJs(item.Path)')" title="Delete">🗑️</button>
                <div class="fm-grid-item-icon fm-icon-@(item.Type == "Folder" ? "folder" : item.Extension?.TrimStart('.') ?? "file")">
                    @if (item.Type == "Folder")
                    {
                        <text>📁</text>
                    }
                    else
                    {
                        @GetFileIcon(item.Extension)
                    }
                </div>
                <div class="fm-grid-item-name" title="@item.Name">@item.Name</div>
                @if (item.Type == "File")
                {
                    <div class="fm-grid-item-info">@FormatFileSize(item.Size)</div>
                }
                else
                {
                    <div class="fm-grid-item-info">Folder</div>
                }
            </div>
        }
    </div>

    <!-- List View (Hidden by default) -->
    <div class="fm-list-view" id="listView" style="display: none;">
        <div class="fm-list-header">
            <!-- 全选复选框 -->
            <div class="fm-list-checkbox-container" onclick="toggleSelectAll()">
                <div class="fm-list-checkbox" id="selectAllCheckbox"></div>
            </div>
            <div></div>
            <div>Name</div>
            <div>Type</div>
            <div>Size</div>
            <div>Modified</div>
            <div>Actions</div>
        </div>
        @foreach (var item in items)
        {
            <div class="fm-list-item" data-path="@item.Path" data-name="@item.Name" data-type="@item.Type">
                <div class="fm-list-checkbox-container" onclick="event.stopPropagation(); toggleItemSelection(this)">
                    <div class="fm-list-checkbox"></div>
                </div>
                <div class="fm-list-icon fm-icon-@(item.Type == "Folder" ? "folder" : item.Extension?.TrimStart('.') ?? "file")"
                     onclick="navigateToItemByElement(this)">
                    @if (item.Type == "Folder")
                    {
                        <text>📁</text>
                    }
                    else
                    {
                        @GetFileIcon(item.Extension)
                    }
                </div>
                <div class="fm-list-name" title="@item.Name" onclick="navigateToItemByElement(this)">@item.Name</div>
                <div class="fm-list-type" onclick="navigateToItemByElement(this)">
                    @if (item.Type == "Folder")
                    {
                        <span class="fm-badge fm-badge-folder">Folder</span>
                    }
                    else
                    {
                        <span class="fm-badge fm-badge-file">@item.Extension</span>
                    }
                </div>
                <div class="fm-list-size" onclick="navigateToItemByElement(this)">
                    @if (item.Type == "File")
                    {
                        @FormatFileSize(item.Size)
                    }
                    else
                    {
                        <text>—</text>
                    }
                </div>
                <div class="fm-list-date" onclick="navigateToItemByElement(this)">@(((DateTime)item.Modified).ToString("MMM dd, yyyy"))</div>
                <div class="fm-list-actions" onclick="event.stopPropagation()">
                    @if (item.Type == "File")
                    {
                        <button class="fm-action-btn download-icon-btn" title="Download"
                                onclick="window.location.href='@Url.Action("Download", "Home", new { path = item.Path })'">
                            <span class="fm-action-icon">📥</span>
                        </button>
                    }
                    else
                    {
                        <button class="fm-action-btn open-icon-btn" title="Open"
                                onclick="window.location.href='@Url.Action("Index", "Home", new { path = item.Path })'">
                            <span class="fm-action-icon">📂</span>
                        </button>
                    }
                    <button class="fm-action-btn delete-icon-btn" title="Delete"
                            onclick="showDeleteModal('@EscapeForJs(item.Name)', '@EscapeForJs(item.Path)')">
                        <span class="fm-action-icon" style="color: #e81123;">🗑️</span>
                    </button>
                </div>
            </div>
        }
    </div>
}